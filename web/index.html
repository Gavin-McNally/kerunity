<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Kerunity</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <style>
      :root{
        --bg:#0e0e0e;
        --surface:#1a1a1a;
        --surface-hover:#222222;
        --border:rgba(255,255,255,0.12);
        --border-strong:rgba(255,255,255,0.18);
        --text:#e8e6e3;
        --text-soft:#c8c6c3;
        --text-muted:#8a8a8a;
        --warm:#c4a882;
        --emergency:#a85a4e;
        --radius:12px;
}
      *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
      body{
        margin:0;
        height:100vh;
        background:var(--bg);
        font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
        display:flex;
        justify-content:center;
        align-items:center;
        overflow:hidden;
        color:var(--text);
        font-size:18px;
        line-height:1.5;
      }

      #app-frame{
        width:100%;
        max-width:390px;
        height:100%;
        max-height:852px;
        background:var(--bg);
        display:flex;
        flex-direction:column;
        overflow:hidden;
        position:relative;
      }
      #app-content{ height:100%; display:flex; flex-direction:column; }
      /* Header */
      header{
        padding:20px 24px 16px;
        padding-top:calc(env(safe-area-inset-top) + 44px);
        flex-shrink:0;
      }
      @media (min-width:360px){
        header{ padding-left:32px; padding-right:32px; }
      }
      @media (min-width:400px){
        header{ padding-left:40px; padding-right:40px; }
      }
      .header-row{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:20px;
        gap:14px;
      }
      .brand{
        font-weight:400;
        font-size:16px;
        color:var(--text-soft);
        letter-spacing:0.2px;
      }
      .header-actions{
        display:flex;
        align-items:center;
        gap:10px;
      }
      .header-actions .pill{ height:48px; min-width:48px; padding:0 14px; }

      /* Buttons */
      .pill{
        height:48px;
        min-width:48px;
        padding:0 16px;
        border-radius:var(--radius);
        border:1px solid var(--border);
        background:var(--surface);
        color:var(--text);
        font-size:16px;
        font-weight:400;
        cursor:pointer;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap:8px;
        user-select:none;
      }
      .pill:active{ opacity:0.7; }
      .pill[disabled]{ cursor:default; opacity:0.4; }
      .pill.active{ background:var(--surface-hover); }
      
      /* Ghost/outline buttons - transparent bg, subtle border */
      .pill-outline{
        background:transparent;
        border:1px solid var(--border-strong);
      }
      .pill-outline:active{ background:rgba(255,255,255,0.03); }

      /* System controls: escape hatches, context, close buttons - no border */
      .pill-ghost{
        background:var(--surface);
        border:none;
      }
      .pill-ghost:hover{ background:var(--surface-hover); }
      .pill-ghost:active{ background:var(--surface); opacity:0.8; }
      .pill-ghost:focus{ outline:none; }
      .pill-ghost:focus-visible{ outline:2px solid var(--warm); outline-offset:2px; }

      /* Emergency tab on home - text only with subtle glow */
      .emergency-tab{
        background:transparent;
        border:none;
        color:var(--emergency);
        font-weight:500;
      }
      .emergency-tab:hover{ background:rgba(168,90,78,0.1); }
      .emergency-tab:active{ opacity:0.8; }
      .emergency-tab:focus{ outline:none; }
      .emergency-tab:focus-visible{ outline:2px solid var(--emergency); outline-offset:2px; }

      .emergency-call-btn{
        background:var(--emergency);
        color:#fff;
        font-weight:500;
      }
      .emergency-call-btn:active{ opacity:0.8; }

      .nhs-advice-btn{
        background:#005EB8;
        color:#fff;
        font-weight:500;
      }
      .nhs-advice-btn:active{ opacity:0.8; }

      .emergency-btn{
        color:var(--emergency);
        font-weight:500;
      }


      .icon-btn{ width:44px; padding:0; justify-content:center; }

      /* Minimal icon button - just the icon, no background */
      .icon-btn-minimal{
        background:transparent;
        border:none;
        padding:8px;
        color:var(--text-muted);
        cursor:pointer;
        border-radius:50%;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .icon-btn-minimal:hover{ color:var(--text); }
      .icon-btn-minimal:active{ opacity:0.7; }
      .icon-btn-minimal:focus{ outline:none; }
      .icon-btn-minimal:focus-visible{ outline:2px solid var(--warm); outline-offset:2px; }

      .subtitle{
        font-size:17px;
        color:var(--text-soft);
        font-weight:400;
        line-height:1.6;
        margin:36px 0 32px;
      }

      /* Canvas */
      .canvas{
        flex:1;
        overflow-y:auto;
        padding:0 24px;
        padding-bottom:calc(env(safe-area-inset-bottom) + 32px);
        scrollbar-width:none;
        -ms-overflow-style:none;
      }
      @media (min-width:360px){
        .canvas{ padding-left:32px; padding-right:32px; }
      }
      @media (min-width:400px){
        .canvas{ padding-left:40px; padding-right:40px; }
      }
      .canvas::-webkit-scrollbar{ width:0; height:0; }

      .search-box{ margin:0 0 36px; position:relative; }
      .search-input{
        width:100%;
        height:60px;
        background:transparent;
        border:1px solid var(--border-strong);
        border-radius:var(--radius);
        padding:0 56px 0 18px;
        color:var(--text);
        font-size:18px;
        font-weight:400;
        outline:none;
      }
      .search-input:focus{ border-color:rgba(255,255,255,0.28); }
      .search-input::placeholder{ color:var(--text-muted); }

      .mic-btn{
        position:absolute;
        right:6px;
        top:6px;
        width:48px;
        height:48px;
        display:flex;
        align-items:center;
        justify-content:center;
        background:transparent;
        border:none;
        color:var(--text-muted);
        cursor:pointer;
        border-radius:var(--radius);
      }
      .mic-btn:active{ background:rgba(255,255,255,0.05); }
      .mic-btn.listening{ 
        color:var(--text); 
        background:rgba(255,255,255,0.08);
        animation:mic-breathe 2.2s ease-in-out infinite;
        animation-delay:200ms;
      }
      @keyframes mic-breathe{
        0%, 100%{ box-shadow:0 0 0 0 rgba(196, 168, 130, 0); }
        50%{ box-shadow:0 0 0 8px rgba(196, 168, 130, 0.15); }
      }
      @media (prefers-reduced-motion: reduce){
        .mic-btn.listening{ animation:none; }
      }


      /* Sections */
      .section-label{
        display:block;
        color:var(--text-muted);
        font-size:14px;
        font-weight:400;
        margin:0 0 18px;
      }
      .dot-green{ display:none; }

      .room-container{
        display:flex;
        flex-direction:column;
        gap:14px;
        margin-bottom:20px;
      }
      .room-container::before{ display:none; }

      .card{
        background:var(--surface);
        border:none;
        border-radius:var(--radius);
        padding:20px;
        cursor:pointer;
        box-shadow:0 0 0 1px rgba(255,255,255,0.04);
      }
      .card:focus{ outline:2px solid var(--warm); outline-offset:2px; }
      .card:active{ background:var(--surface-hover); }

      .glyph{ display:none; }
      .card-title{ font-size:21px; font-weight:500; line-height:1.35; color:var(--text); margin-bottom:8px; }
      .card-sub{ font-size:15px; font-weight:400; color:var(--text-muted); line-height:1.4; opacity:0.65; }

      .view-all-btn{
        width:100%;
        padding:16px;
        margin-top:12px;
        background:transparent;
        border:none;
        border-radius:var(--radius);
        color:var(--text-muted);
        font-size:16px;
        font-weight:400;
        cursor:pointer;
        min-height:56px;
      }
      .view-all-btn:active{ opacity:0.7; }

      /* Bottom Sheet (Info only) */
      .sheet-backdrop{
        position:absolute;
        inset:0;
        background:rgba(0,0,0,0.88);
        z-index:100;
        opacity:0;
        pointer-events:none;
        display:flex;
        align-items:center;
        justify-content:center;
        padding:24px;
      }
      .sheet-backdrop.active{ opacity:1; pointer-events:auto; }
      .sheet{
        background:var(--bg);
        border:1px solid var(--border-strong);
        border-radius:20px;
        padding:32px 28px;
        max-width:380px;
        width:100%;
        max-height:80vh;
        overflow-y:auto;
        scrollbar-width:none;
        -ms-overflow-style:none;
      }
      .sheet::-webkit-scrollbar{ width:0; height:0; }

      /* Emergency: Full screen takeover, solid background */
      .emergency-backdrop{
        position:absolute;
        inset:0;
        z-index:120;
        background:var(--bg);
        opacity:0;
        pointer-events:none;
      }
      .emergency-backdrop.active{
        opacity:1;
        pointer-events:auto;
      }
      .emergency-screen{
        position:absolute;
        inset:0;
        background:var(--bg);
        display:flex;
        flex-direction:column;
        padding:32px;
        padding-top:calc(env(safe-area-inset-top) + 24px);
        padding-bottom:calc(env(safe-area-inset-bottom) + 32px);
      }
      /* Hide scrollbar in emergency screen */
      .emergency-scroll{
        scrollbar-width:none;
        -ms-overflow-style:none;
      }
      .emergency-scroll::-webkit-scrollbar{ width:0; height:0; }

      .sheet-title{
        color:var(--text);
        font-size:19px;
        font-weight:500;
        margin-bottom:20px;
      }

      .urgent-row{
        width:100%;
        display:flex;
        align-items:center;
        gap:16px;
        padding:20px;
        background:var(--surface);
        border:none;
        border-radius:var(--radius);
        margin-bottom:14px;
        text-align:left;
        color:var(--text);
        cursor:pointer;
        box-shadow:0 0 0 1px rgba(255,255,255,0.04);
      }
      .urgent-row:focus{ outline:2px solid var(--warm); outline-offset:2px; }
      .urgent-row:active{ background:var(--surface-hover); }
      .u-icon{ display:none; }

      /* Crisis Card Full Screen */
      .stepdown-backdrop{
        position:absolute;
        inset:0;
        z-index:130;
        background:var(--bg);
        opacity:0;
        pointer-events:none;
      }
      .stepdown-backdrop.active{
        opacity:1;
        pointer-events:auto;
      }
      .stepdown-screen{
        position:absolute;
        inset:0;
        background:var(--bg);
        display:flex;
        flex-direction:column;
        padding:24px 40px;
        padding-top:calc(env(safe-area-inset-top) + 28px);
        padding-bottom:calc(env(safe-area-inset-bottom) + 40px);
      }
      .stepdown-backdrop.active .stepdown-screen{
        opacity:1;
      }

      .stepdown-body{
        flex:1;
        overflow:auto;
        padding:24px 0;
        scrollbar-width:none;
        -ms-overflow-style:none;
        display:flex;
        flex-direction:column;
        justify-content:center;
      }
      .stepdown-body::-webkit-scrollbar{ width:0; height:0; }

      .crisis-card{
        width:100%;
        padding:0 24px;
        display:flex;
        flex-direction:column;
        justify-content:center;
      }

      .kicker{
        font-size:17px;
        font-weight:500;
        color:var(--warm);
        letter-spacing:0.02em;
        margin-bottom:10px;
      }
      .say-text{
        font-size:28px;
        font-weight:500;
        line-height:1.35;
        color:var(--text);
      }
      .divider{
        height:1px;
        background:var(--border);
        margin:24px 0;
      }
      .do-text{
        font-size:18px;
        font-weight:400;
        color:var(--text-muted);
        line-height:1.5;
      }
      /* DO-only steps: instruction text is largest in app */
      .do-text.do-only{
        font-size:32px;
        font-weight:500;
        color:var(--text);
        line-height:1.3;
      }
      
      /* Inline tappable emergency number - subtle button-like, not alarm-red */
      .inline-call{
        display:inline-flex;
        align-items:center;
        justify-content:center;
        background:rgba(255,255,255,0.04);
        border:1px solid rgba(255,255,255,0.22);
        color:var(--text);
        font-weight:700;
        font-size:inherit;
        padding:2px 10px;
        border-radius:10px;
        cursor:pointer;
        min-height:32px;
        vertical-align:middle;
        margin:0 2px;
      }
      .inline-call:focus-visible{
        outline:2px solid rgba(255,255,255,0.5);
        outline-offset:2px;
        background:rgba(255,255,255,0.08);
      }
      .inline-call:active{
        transform:scale(0.98);
        opacity:0.85;
      }
      /* Larger in DO-only mode, still not red */
      .do-text.do-only .inline-call{
        padding:4px 12px;
        min-height:40px;
        font-size:28px;
      }

      .stepdown-footer{
        padding-top:28px;
        padding-bottom:8px;
      }

      /* Switch link style (used in footer) */
      .switch-link{
        background:none;
        border:none;
        color:var(--text-muted);
        font-size:14px;
        text-decoration:underline;
        text-underline-offset:2px;
        cursor:pointer;
        padding:4px 8px;
        opacity:0.8;
      }
      .switch-link:hover,.switch-link:focus-visible{
        opacity:1;
        color:var(--text);
      }

      /* Continue chip (home screen resume shortcut) - passive memory, not action */
      .continue-chip{
        padding:0 32px;
        margin-bottom:20px;
        text-align:center;
      }
      .continue-btn{
        display:inline-flex;
        flex-direction:column;
        align-items:center;
        gap:2px;
        padding:12px 24px 14px;
        min-width:180px;
        max-width:260px;
        background:transparent;
        border:1px solid var(--border);
        border-bottom:none;
        border-radius:10px 10px 0 0;
        cursor:pointer;
        text-align:center;
        position:relative;
      }
      /* Left curve - Chrome tab style */
      .continue-btn::before{
        content:"";
        position:absolute;
        left:-8px;
        bottom:0;
        width:8px;
        height:8px;
        background:transparent;
        border-bottom-right-radius:8px;
        box-shadow:4px 0 0 0 var(--bg);
        border-right:1px solid var(--border);
        border-bottom:1px solid var(--border);
      }
      /* Right curve - Chrome tab style */
      .continue-btn::after{
        content:"";
        position:absolute;
        right:-8px;
        bottom:0;
        width:8px;
        height:8px;
        background:transparent;
        border-bottom-left-radius:8px;
        box-shadow:-4px 0 0 0 var(--bg);
        border-left:1px solid var(--border);
        border-bottom:1px solid var(--border);
      }
      .continue-btn:active{ opacity:0.85; }
      .continue-label{
        font-size:14px;
        color:var(--text-muted);
        font-weight:400;
      }
      .continue-detail{
        font-size:14px;
        color:var(--text-muted);
        font-weight:400;
      }

      /* Post-emergency reassurance */
      .reassurance-banner{
        background:rgba(196, 168, 130, 0.12);
        border-left:3px solid var(--warm);
        padding:12px 16px;
        margin-top:12px;
        font-size:15px;
        color:var(--text);
        border-radius:0 var(--radius) var(--radius) 0;
      }

      /* Toast notification (replaces alert()) */
      .toast{
        position:fixed;
        bottom:calc(env(safe-area-inset-bottom) + 24px);
        left:50%;
        transform:translateX(-50%) translateY(100px);
        background:var(--surface);
        color:var(--text);
        padding:14px 20px;
        border-radius:var(--radius);
        font-size:15px;
        max-width:calc(100% - 48px);
        text-align:center;
        opacity:0;
        pointer-events:none;
        transition:transform 0.2s ease, opacity 0.2s ease;
        z-index:1200;
        border:1px solid rgba(255,255,255,0.1);
      }
      .toast.show{
        transform:translateX(-50%) translateY(0);
        opacity:1;
      }

      /* Resume prompt (calm-tech confirm replacement) */
      .resume-backdrop{
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.88);
        display:flex;
        align-items:center;
        justify-content:center;
        padding:32px;
        opacity:0;
        pointer-events:none;
        transition:opacity 0.15s ease;
        z-index:1100;
      }
      .resume-backdrop.active{
        opacity:1;
        pointer-events:auto;
      }
      .resume-sheet{
        background:var(--bg);
        border:1px solid var(--border-strong);
        border-radius:20px;
        padding:32px 28px;
        max-width:340px;
        width:100%;
        text-align:center;
      }
      .resume-title{
        font-size:19px;
        font-weight:500;
        color:var(--text);
        margin-bottom:12px;
      }
      .resume-sub{
        font-size:16px;
        color:var(--text-muted);
        margin-bottom:6px;
      }
      .resume-hint{
        font-size:14px;
        color:var(--text-muted);
        opacity:0.8;
        margin-bottom:28px;
      }
      .resume-buttons{
        display:flex;
        flex-direction:column;
        gap:14px;
      }

      /* Post-completion follow-up */
      .followup-backdrop{
        position:fixed;
        inset:0;
        background:rgba(0,0,0,0.88);
        display:flex;
        align-items:center;
        justify-content:center;
        padding:32px;
        opacity:0;
        pointer-events:none;
        transition:opacity 0.2s ease;
        z-index:1100;
      }
      .followup-backdrop.active{
        opacity:1;
        pointer-events:auto;
      }
      .followup-card{
        background:var(--bg);
        border:1px solid var(--border-strong);
        border-radius:20px;
        padding:36px 32px 40px;
        width:100%;
        max-width:360px;
        text-align:center;
        position:relative;
      }
      .followup-card-minimal{
        background:transparent;
        padding:20px 28px;
        max-width:280px;
      }
      .followup-close{
        position:absolute;
        top:12px;
        right:12px;
        width:36px;
        height:36px;
        border-radius:50%;
        border:none;
        background:transparent;
        color:var(--text-muted);
        cursor:pointer;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .followup-close:hover{ background:rgba(255,255,255,0.05); }
      .followup-close:active{ opacity:0.7; }
      .followup-title{
        font-size:19px;
        font-weight:500;
        color:var(--text);
        margin-bottom:28px;
        line-height:1.4;
      }
      .followup-buttons{
        display:flex;
        flex-direction:column;
        gap:16px;
      }
      .followup-btn{
        width:100%;
        height:56px;
        border-radius:var(--radius);
        border:1px solid var(--border-strong);
        background:transparent;
        color:var(--text);
        font-size:16px;
        font-weight:500;
        cursor:pointer;
        transition:all 0.15s ease;
        display:flex;
        align-items:center;
        justify-content:center;
        gap:10px;
      }
      .followup-btn:active{ transform:scale(0.98); opacity:0.9; }
      .followup-btn::before{
        content:"";
        width:8px;
        height:8px;
        border-radius:50%;
        flex-shrink:0;
      }
      .followup-btn.calmer::before{ background:#7ab37a; }
      .followup-btn.same::before{ background:#b8a86a; }
      .followup-btn.worse::before{ background:#b36a5a; }
      .followup-response-text{
        font-size:18px;
        color:var(--text);
        line-height:1.5;
        margin-bottom:32px;
      }
      .followup-response-buttons{
        display:flex;
        flex-direction:column;
        gap:16px;
      }

      .muted-link{
        background:none;
        border:none;
        width:100%;
        margin-top:16px;
        padding:12px 0;
        text-decoration:underline;
        font-size:14px;
        color:var(--text-muted);
        font-weight:400;
        cursor:pointer;
        min-height:44px;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .muted-link:active{ opacity:0.7; }

      .listen-btn{
        display:flex;
        align-items:center;
        justify-content:center;
        gap:10px;
        height:48px;
        padding:0 16px;
        border-radius:var(--radius);
        border:none;
        background:var(--surface);
        color:var(--text);
        font-size:16px;
        font-weight:400;
        cursor:pointer;
        white-space:nowrap;
      }
      .listen-btn:active{ opacity:0.7; }
      .listen-btn.speaking{ background:var(--surface-hover); }
      /* Listen as support role - more subtle */
      .listen-btn.listen-secondary{
        height:44px;
        background:transparent;
        border:1px solid rgba(255,255,255,0.12);
        color:var(--text-muted);
        font-size:15px;
      }
      .listen-btn.listen-secondary:active{ background:rgba(255,255,255,0.05); }

      /* Inline listen button (under SAY text, crisis mode) */
      .listen-inline{
        display:inline-flex;
        align-items:center;
        gap:8px;
        margin-top:16px;
        padding:10px 16px;
        min-height:42px;
        border-radius:21px;
        border:1px solid rgba(255,255,255,0.12);
        background:transparent;
        color:var(--text-muted);
        font-size:14px;
        cursor:pointer;
      }
      .listen-inline:active{ background:rgba(255,255,255,0.05); }
      .listen-inline.speaking{ background:rgba(255,255,255,0.08); color:var(--text); }

      /* Reduced motion */
      @media (prefers-reduced-motion: reduce){
        *{ transition:none !important; animation:none !important; }
      }
    </style>
  </head>

  <body>
    <div id="app-frame">
      <div id="app-content">
        <header>
          <div class="header-row">
            <div class="brand">Kerunity</div>

            <div class="header-actions">
              <button class="icon-btn-minimal" id="info-open" type="button" aria-label="Info">
                <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 16v-4"></path>
                  <path d="M12 8h.01"></path>
                </svg>
              </button>
              <button class="pill emergency-tab" type="button" id="urgent-open">Emergency</button>
            </div>
          </div>

          <div class="subtitle">
            Start here. You don't have to get this right.
          </div>
          
          <!-- Post-emergency reassurance (hidden by default) -->
          <div id="reassurance-banner" class="reassurance-banner" style="display:none;">
            You did the right thing.
          </div>
        </header>

        <div class="canvas">
          <div class="search-box">
            <input id="query" type="text" class="search-input" placeholder="Search situations">
            <button id="mic-btn" class="mic-btn" type="button" aria-label="Speak">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" x2="12" y1="19" y2="22"></line>
              </svg>
            </button>
            </div>

          <div id="search-suggestions" class="room-container" style="display:none;"></div>

          <!-- Continue chip: shows if crisis or urgent deck was exited mid-flow -->
          <div id="continue-chip" class="continue-chip" style="display:none;" data-resume-type="">
            <button id="continue-btn" type="button" class="continue-btn">
              <span id="continue-label" class="continue-label">Continue where you left off</span>
              <span id="continue-detail" class="continue-detail">Refusing meds Â· Step 3</span>
            </button>
          </div>

          <div id="common-home-section">
            <div class="section-label">Common situations</div>
            <div id="grid-container" class="room-container"></div>
            <button id="view-all-btn" type="button" class="view-all-btn" style="display:none;">
              View all situations
            </button>
          </div>
        </div>

        <!-- Crisis Card Screen -->
        <div id="stepdown-overlay" class="stepdown-backdrop" aria-hidden="true">
          <div class="stepdown-screen" role="dialog" aria-modal="true" aria-label="Crisis Card">
            <!-- Header: Title left, Close right. Never wrap. -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px;padding:6px 0;">
              <div style="flex:1;min-width:0;">
                <div id="stepdown-title" style="font-size:18px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Situation</div>
                <div id="stepdown-progress" style="font-size:16px;color:var(--text-muted);margin-top:6px;">Step 1 of 4</div>
              </div>
              <button id="stepdown-close" class="pill pill-ghost" type="button" aria-label="Close" style="flex-shrink:0;">Close</button>
            </div>

            <div class="stepdown-body">
              <div class="crisis-card">
                <div id="stepdown-say-section">
                  <div id="stepdown-say-kicker" class="kicker">Try saying this</div>
                  <div id="stepdown-say" class="say-text"></div>
                  <!-- Listen: inline tool under SAY text (crisis decks) -->
                  <button id="listen-inline" class="listen-inline" type="button" aria-label="Listen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                      <path d="M11 5 6 9H2v6h4l5 4V5Z"></path>
                      <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                    <span class="listen-inline-label">Listen</span>
                  </button>
                  <div class="divider"></div>
                </div>
                <div id="stepdown-do-kicker" class="kicker">You can do this</div>
                <div id="stepdown-do" class="do-text"></div>
                </div>
              </div>

            <div class="stepdown-footer">
              <!-- URGENT MODE: Call + Listen in footer -->
              <button id="stepdown-call" class="pill emergency-call-btn" type="button" style="display:none;width:100%;height:56px;font-size:18px;margin-bottom:24px;">
                <span id="stepdown-call-label"></span>
              </button>
              <button id="listen-btn" class="listen-btn listen-secondary" type="button" aria-label="Listen" style="display:none;width:100%;margin-bottom:20px;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M11 5 6 9H2v6h4l5 4V5Z"></path>
                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                  </svg>
                  <span class="listen-label">Listen</span>
                </button>

              <!-- CRISIS MODE: Back to situations link (above nav) -->
              <div id="back-to-situations" style="display:none;text-align:center;margin:24px 0 20px;">
                <button id="switch-situation" class="switch-link" type="button" aria-label="Back to situations list">Back to situations</button>
            </div>

              <!-- Navigation: Back / Next -->
              <div style="display:flex;gap:14px;margin-bottom:24px;">
                <button id="stepdown-back" class="pill pill-outline" type="button" style="flex:1;">Back</button>
                <button id="stepdown-next" class="pill pill-outline" type="button" style="flex:1;">Next</button>
            </div>

              <!-- URGENT MODE: Back to emergency list -->
              <div id="back-to-urgent" style="display:none;text-align:center;margin-bottom:20px;">
                <button id="back-to-urgent-btn" class="switch-link" type="button" aria-label="Back to emergency list">Wrong emergency? Back to list</button>
            </div>

              <!-- CRISIS MODE: Emergency button (no hint text - button speaks for itself) -->
              <button id="stepdown-emergency" class="pill pill-outline emergency-btn" type="button" style="display:none;width:100%;height:48px;margin-top:8px;">Emergency</button>
            </div>
          </div>
        </div>

        <!-- Emergency: Full screen takeover -->
        <div id="urgent-overlay" class="emergency-backdrop" aria-hidden="true">
          <div class="emergency-screen" role="dialog" aria-modal="true" aria-label="Emergency Help">
            <!-- Header: title left, close right -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px;">
              <div style="font-size:18px;font-weight:500;color:var(--text);">Emergency</div>
              <button id="urgent-close" class="pill pill-ghost" type="button" aria-label="Close" style="flex-shrink:0;">Close</button>
        </div>

            <div class="emergency-scroll" style="flex:1;overflow-y:auto;">
              <div id="emergency-hint" style="font-size:17px;color:var(--text);margin-bottom:24px;line-height:1.5;">
                If someone is in immediate danger, call now.
            </div>

              <div id="call-buttons" style="display:flex;gap:14px;margin-bottom:32px;">
                <button id="call-emergency" type="button" class="pill emergency-call-btn" style="flex:1;height:88px;flex-direction:column;gap:6px;">
                  <span id="emergency-number" style="font-size:24px;font-weight:600;"></span>
                  <span style="font-size:14px;opacity:0.75;">Emergency</span>
              </button>
                <button id="call-advice" type="button" class="pill nhs-advice-btn" style="flex:1;height:88px;flex-direction:column;gap:6px;">
                  <span id="advice-number" style="font-size:24px;font-weight:600;"></span>
                  <span style="font-size:14px;opacity:0.75;">Medical advice</span>
              </button>
            </div>

              <div style="font-size:14px;color:var(--text-muted);margin-bottom:12px;">Safety checks</div>
            <div id="urgent-grid-sheet"></div>
            </div>
          </div>
        </div>

        <!-- Info sheet -->
        <div id="info-overlay" class="sheet-backdrop" aria-hidden="true">
          <div class="sheet" role="dialog" aria-modal="true" aria-label="Info">
            
            <!-- Header -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:28px;">
              <div style="font-size:19px;font-weight:500;color:var(--text);">About Kerunity</div>
              <button id="info-close" class="pill pill-ghost" type="button" style="flex-shrink:0;height:40px;padding:0 16px;font-size:15px;">Close</button>
            </div>

            <!-- Main description -->
            <div style="font-size:17px;color:var(--text);line-height:1.5;margin-bottom:32px;">
              Calm, step-by-step guidance for carers.
            </div>

            <!-- Safety notes -->
            <div style="margin-bottom:28px;">
              <p id="info-emergency-line" style="margin:0 0 20px;color:var(--text);font-size:16px;font-weight:500;line-height:1.5;"></p>
              <div style="color:var(--text-muted);line-height:1.8;font-size:15px;">
                <p style="margin:0 0 12px;">This is guidance, not medical advice.</p>
                <p style="margin:0 0 12px;">Keep everyone safe. Step away if you need to.</p>
                <p style="margin:0;">Tap Emergency for safety checks.</p>
              </div>
            </div>

            <!-- Divider -->
            <div style="height:1px;background:var(--border);margin-bottom:28px;"></div>

            <!-- Privacy section -->
            <div>
              <div style="font-size:16px;font-weight:500;color:var(--text);margin-bottom:16px;">Your privacy</div>
              <div style="color:var(--text-muted);line-height:1.8;font-size:15px;">
                <p style="margin:0 0 12px;">Your voice is never recorded.</p>
                <p style="margin:0 0 12px;">This app does not track you.</p>
                <p style="margin:0;">If you use this inside ChatGPT, OpenAI may save what you type.</p>
              </div>
            </div>

          </div>
        </div>

        <!-- Toast notification (replaces native alert) -->
        <div id="toast" class="toast" role="status" aria-live="polite"></div>

        <!-- Resume prompt (replaces native confirm) -->
        <div id="resume-overlay" class="resume-backdrop" aria-hidden="true">
          <div class="resume-sheet" role="dialog" aria-modal="true" aria-label="Resume">
            <div class="resume-title">Pick up where you left off?</div>
            <div id="resume-step" class="resume-sub">Step 4</div>
            <div class="resume-hint">Only if this is still the same situation.</div>
            <div class="resume-buttons">
              <button id="resume-continue" class="pill pill-outline" type="button" style="width:100%;height:56px;font-size:16px;">Continue</button>
              <button id="resume-restart" class="pill pill-outline" type="button" style="width:100%;height:56px;font-size:16px;">Start from Step 1</button>
            </div>
          </div>
        </div>

        <!-- Post-completion follow-up -->
        <div id="followup-overlay" class="followup-backdrop" aria-hidden="true">
          <div class="followup-card" role="dialog" aria-modal="true" aria-label="Follow-up">
            <button id="followup-close" class="followup-close" type="button" aria-label="Close">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M18 6 6 18"></path>
                <path d="m6 6 12 12"></path>
              </svg>
            </button>
            <div class="followup-title">How is it feeling now?</div>
            <div class="followup-buttons">
              <button id="followup-calmer" class="followup-btn calmer" type="button">
                <span class="followup-btn-label">Calmer</span>
              </button>
              <button id="followup-same" class="followup-btn same" type="button">
                <span class="followup-btn-label">About the same</span>
              </button>
              <button id="followup-worse" class="followup-btn worse" type="button">
                <span class="followup-btn-label">Worse</span>
            </button>
            </div>
          </div>
        </div>

        <!-- Follow-up response screens -->
        <div id="followup-response-overlay" class="followup-backdrop" aria-hidden="true">
          <div class="followup-card" role="dialog" aria-modal="true" aria-label="Response">
            <div id="followup-response-text" class="followup-response-text"></div>
            <div id="followup-response-buttons" class="followup-response-buttons"></div>
          </div>
        </div>
      </div>
    </div>

    <script>
      /* =========================
         DATA
      ========================== */
      /* Visible by default (Hick's Law: 6 is safe, 10 is limit) */
      const VISIBLE_COUNT = 6;

      const DATA = {
        /* Most common - shown first (6) - EXPANDED COVERAGE */
        refusing_meds: { 
          label: "Refusing meds", sub: "Won't take pills",
          keywords: ["medication", "pills", "tablets", "medicine", "drugs", "prescription", "dose", "swallow", "spit", "meds", "capsule", "liquid", "syrup", "pharmacy", "chemist", "GP", "doctor"],
          aliases: ["won't take medication", "refusing tablets", "spitting out pills", "hiding medication", "not taking medicine", "refuses to swallow", "won't swallow pills", "spits out tablets", "hiding pills in mouth", "says no to meds", "fighting medication", "won't open mouth for pills", "clamping mouth shut"]
        },
        wants_home: { 
          label: "Wants to go home", sub: "Confused about location",
          keywords: ["home", "leave", "go", "house", "back", "where", "lost", "place", "live", "bus", "taxi", "car", "door", "outside", "family", "parents", "childhood"],
          aliases: ["wants to leave", "going home", "take me home", "where do I live", "this isn't my house", "I want to go", "not my home", "need to get the bus", "waiting for a taxi", "when can I go home", "I don't live here", "where's my house", "wants to see parents", "going back to childhood home", "doesn't recognise house"]
        },
        asking_mom: { 
          label: "Asking for mom", sub: "Deceased relative",
          keywords: ["mom", "mum", "mother", "dad", "father", "parent", "dead", "deceased", "passed", "gone", "husband", "wife", "spouse", "nan", "grandma", "grandad", "brother", "sister"],
          aliases: ["where's my mum", "wants her mother", "asking for father", "when is mum coming", "I want my mum", "where's mom", "waiting for dad", "when's mum picking me up", "I need my mother", "where's my husband", "have you seen my wife", "asking for dead relative", "wants to see nan"]
        },
        stealing: { 
          label: "Accusing of stealing", sub: "Items 'missing'",
          keywords: ["stealing", "stole", "thief", "taken", "missing", "wallet", "money", "purse", "keys", "accuse", "blame", "robbed", "lost", "jewellery", "jewelry", "ring", "watch", "handbag", "bag"],
          aliases: ["says I stole", "accusing me", "thinks I took", "where's my money", "someone stole", "you took my", "things are missing", "keeps saying I stole it", "accusing carers of theft", "blaming me for stealing", "can't find wallet", "purse is missing", "who took my keys", "someone's been in my things", "money has gone"]
        },
        shadowing: { 
          label: "Shadowing", sub: "Following you constantly",
          keywords: ["following", "shadow", "clingy", "attached", "close", "behind", "everywhere", "stuck", "separation", "anxious", "needy", "dependent"],
          aliases: ["follows me everywhere", "won't let me out of sight", "always behind me", "can't leave them alone", "follows me around", "follows me to the toilet", "follows me to bathroom", "won't stay in room alone", "panics when I leave", "attached to my hip", "can't get any space", "follows room to room"]
        },
        hygiene: { 
          label: "Refusing hygiene", sub: "Won't wash/change",
          keywords: ["wash", "bath", "shower", "clean", "hygiene", "smell", "dirty", "change", "clothes", "teeth", "toilet", "bathroom", "loo", "nappy", "diaper", "pad", "incontinence", "wet", "soiled"],
          aliases: ["won't wash", "refusing bath", "won't shower", "hasn't changed clothes", "needs a wash", "refusing to clean", "won't brush teeth", "scared of shower", "afraid of bath", "won't change wet clothes", "sitting in wet pad", "smells bad", "hasn't bathed in days", "refuses personal care", "won't let me wash them"]
        },
        /* Extended - shown on "View all" (19 more = 25 total) - EXPANDED COVERAGE */
        sundowning: { 
          label: "Sundowning", sub: "Evening agitation",
          keywords: ["evening", "night", "sunset", "agitated", "restless", "worse", "afternoon", "dusk", "dark", "twilight", "late", "shadows", "anxious", "confused", "pacing", "upset"],
          aliases: ["gets worse at night", "evening agitation", "restless at sunset", "anxious in evening", "agitated after dark", "worse in late afternoon", "pacing at night", "confused when it gets dark", "sundown syndrome", "evening confusion", "worse as sun goes down", "unsettled at teatime", "bad every evening"]
        },
        wont_eat: { 
          label: "Won't eat", sub: "Refusing food/drink",
          keywords: ["eat", "food", "drink", "hungry", "meal", "appetite", "swallow", "chew", "water", "tea", "coffee", "breakfast", "lunch", "dinner", "snack", "thirsty", "dehydrated", "weight"],
          aliases: ["not eating", "refusing food", "won't drink", "no appetite", "stopped eating", "pushing food away", "spitting food out", "won't open mouth", "not drinking enough", "losing weight", "barely eating", "picks at food", "won't touch meals", "refusing tea", "dehydrated"]
        },
        repetitive: { 
          label: "Repeating questions", sub: "Asking same thing",
          keywords: ["repeat", "again", "same", "question", "asking", "over", "loop", "constant", "broken", "record", "endless", "nonstop", "obsessive", "stuck"],
          aliases: ["asking same thing", "keeps repeating", "same question", "over and over", "asks constantly", "broken record", "asked this already", "keeps asking same thing", "won't stop asking", "repetitive questions", "stuck in a loop", "asks every five minutes", "endless questions"]
        },
        aggression: { 
          label: "Aggression", sub: "Shouting / hitting / throwing things",
          keywords: ["aggressive", "hitting", "shouting", "angry", "violent", "punch", "kick", "yelling", "attack", "slap", "bite", "scratch", "push", "shove", "grab", "rage", "fury", "temper"],
          aliases: ["being aggressive", "hit me", "shouting at me", "getting violent", "lashing out", "tried to punch me", "kicked me", "grabbed my arm", "scratched me", "bit me", "pushed me away", "screaming at me", "flew into a rage", "lost their temper", "threatening behaviour"]
        },
        sleep: { 
          label: "Sleep problems", sub: "Up at night",
          keywords: ["sleep", "night", "awake", "insomnia", "tired", "bed", "rest", "waking", "wandering", "nocturnal", "disturbed", "exhausted", "morning", "routine", "nap", "daytime"],
          aliases: ["can't sleep", "up all night", "won't go to bed", "waking up", "not sleeping", "wandering at night", "awake at 3am", "thinks it's morning", "sleeping all day", "day night reversed", "exhausted but won't sleep", "gets up repeatedly", "disturbed sleep pattern", "night time wandering"]
        },
        lost: { 
          label: "Lost / confused", sub: "Doesn't recognise place",
          keywords: ["lost", "confused", "where", "recognise", "place", "room", "house", "disoriented"],
          aliases: ["doesn't know where", "seems lost", "very confused", "doesn't recognise"]
        },
        wandering: { 
          label: "Wandering", sub: "Trying to leave",
          keywords: ["wander", "walk", "leave", "door", "outside", "escape", "exit", "roam", "pacing", "restless", "garden", "street", "lost", "front", "back", "gate", "key", "lock"],
          aliases: ["trying to leave", "at the door", "wants to go outside", "keeps wandering", "walking around", "trying to get out", "pacing up and down", "found at front door", "went out the back", "escaped from house", "wandered off", "walking the streets", "let themselves out", "keeps trying door handle", "looking for way out"]
        },
        hiding: { 
          label: "Hiding things", sub: "Can't find items",
          keywords: ["hiding", "hidden", "lost", "find", "where", "put", "missing", "moved"],
          aliases: ["hides things", "can't find", "where did I put", "things go missing", "hidden items"]
        },
        undressing: { 
          label: "Undressing", sub: "Removing clothes",
          keywords: ["undress", "naked", "clothes", "strip", "remove", "taking off"],
          aliases: ["taking clothes off", "getting undressed", "removing clothes", "keeps undressing"]
        },
        rummaging: { 
          label: "Rummaging", sub: "Going through drawers",
          keywords: ["rummage", "drawer", "cupboard", "search", "through", "looking", "mess"],
          aliases: ["going through drawers", "searching cupboards", "making a mess", "rummaging around"]
        },
        hoarding: { 
          label: "Hoarding", sub: "Collecting / keeping things",
          keywords: ["hoard", "collect", "keep", "save", "pile", "stuff", "junk", "rubbish"],
          aliases: ["collecting things", "won't throw away", "keeping everything", "piling up stuff"]
        },
        crying: { 
          label: "Crying / tearful", sub: "Upset for no clear reason",
          keywords: ["crying", "tears", "upset", "sad", "weeping", "emotional", "distressed"],
          aliases: ["keeps crying", "very upset", "tearful", "crying for no reason", "emotionally distressed"]
        },
        wont_get_up: { 
          label: "Won't get up", sub: "Staying in bed",
          keywords: ["bed", "up", "get", "lying", "stay", "morning", "wake"],
          aliases: ["won't get out of bed", "staying in bed", "refuses to get up", "won't wake up"]
        },
        refusing_help: { 
          label: "Refusing help", sub: "Won't accept care",
          keywords: ["help", "refuse", "care", "assist", "support", "independent", "stubborn"],
          aliases: ["won't accept help", "refuses care", "pushes me away", "doesn't want help"]
        },
        paranoid: { 
          label: "Paranoid", sub: "Suspicious of others",
          keywords: ["paranoid", "suspicious", "trust", "people", "watching", "spy", "conspiracy", "poison", "plotting", "neighbour", "neighbor", "carer", "staff", "delusion", "persecuted", "threatened"],
          aliases: ["very suspicious", "doesn't trust", "thinks people are watching", "paranoid thoughts", "thinks I'm poisoning food", "says neighbours are spying", "accuses staff of plotting", "doesn't trust anyone", "thinks people want to hurt them", "suspicious of carers", "feels persecuted", "convinced someone is after them", "paranoid about visitors"]
        },
        hallucinations: { 
          label: "Seeing things", sub: "Things that aren't there",
          keywords: ["seeing", "hallucination", "vision", "people", "things", "imaginary", "hear", "voices", "children", "intruders", "strangers", "animals", "bugs", "insects", "dead", "deceased", "ghost", "shadow"],
          aliases: ["seeing things", "hearing voices", "people that aren't there", "hallucinating", "sees children in the room", "talking to dead relatives", "sees intruders", "thinks there are strangers here", "seeing animals", "bugs on the wall", "sees shadows moving", "talking to people who aren't there", "says someone is in the house", "visual hallucinations"]
        },
        inappropriate: { 
          label: "Inappropriate comments", sub: "Saying awkward things",
          keywords: ["inappropriate", "rude", "sexual", "comments", "embarrassing", "awkward", "offensive"],
          aliases: ["saying inappropriate things", "rude comments", "embarrassing behaviour", "sexual comments"]
        },
        wont_dress: { 
          label: "Won't get dressed", sub: "Refusing clothes",
          keywords: ["dress", "clothes", "wear", "outfit", "change", "morning", "pyjamas"],
          aliases: ["won't get dressed", "refusing to dress", "staying in pyjamas", "won't change clothes"]
        },
        forgot_face: { 
          label: "Doesn't know me", sub: "Forgotten who you are",
          keywords: ["know", "recognise", "who", "face", "forget", "stranger", "remember"],
          aliases: ["doesn't recognise me", "forgot who I am", "thinks I'm a stranger", "doesn't know who I am"]
        },
        /* FALLBACK - never shown in list */
        fallback_not_sure: {
          label: "Not sure what this is", sub: "Start here. One step at a time.",
          isFallback: true,
          keywords: [],
          aliases: []
        }
      };

      const CRISIS_DECKS = {
        refusing_meds:{ title:"Refusing meds", steps:[
          { say:"It's okay. We don't have to do this right now.", do:"Take the pressure off. Relax your shoulders. Speak slowly." },
          { say:"Can we take a sip of water first, then decide?", do:"Offer one tiny first step. Give two choices: water or tea." },
          { say:"Would you like to take it with me, or would you prefer later?", do:"Give two acceptable options. Avoid saying 'you must'." },
          { say:"Thank you. That's enough for now. We'll check again later.", do:"Say \"That's okay. We'll try later.\" Then stop asking for now. Try again in 10-20 minutes. If you're worried, call for medical advice." }
        ]},
        wants_home:{ title:"Wants to go home", steps:[
          { say:"I hear you. You want to go home. Tell me about home.", do:"Validate and invite description. Don't correct location facts." },
          { say:"Let's get you comfortable first, then we'll make a plan.", do:"Move to comfort: chair, drink, loo, warmer/blanket." },
          { say:"Shall we have a cup of tea first, then we'll decide?", do:"Use a short delay + familiar ritual. Keep it calm and simple." },
          { say:"You're safe with me. We'll sort it together.", do:"Close with safety + togetherness. Reduce stimulation." }
        ]},
        asking_mom:{ title:"Asking for mom", steps:[
          { say:"You miss her. Tell me about her.", do:"Join the emotion. Don't correct facts." },
          { say:"What would she want you to do right now?", do:"Redirect toward a safe action (sit, tea, photo, music)." },
          { say:"Letâs do something that would make her proud.", do:"Small task: fold towel, water plant, look at album." },
          { say:"Iâm here with you. Youâre not on your own.", do:"Close with reassurance and presence." }
        ]},
        stealing:{ title:"Accusing of stealing", steps:[
          { say:"That sounds really worrying. Letâs look together.", do:"Validate. Avoid defending yourself or debating." },
          { say:"Where did you last remember seeing it?", do:"Turn into a âsearch missionâ with gentle questions." },
          { say:"Letâs check the usual safe places first.", do:"Go to 2â3 common spots only. Keep pace slow." },
          { say:"If itâs not here, weâll leave it and try again later.", do:"Close without âyouâre wrongâ. Offer a calming reset." }
        ]},
        shadowing:{ title:"Shadowing", steps:[
          { say:"You're okay. I'm here. Let's do this together.", do:"Reassure first. Keep tone warm, not hurried." },
          { say:"Could you sit here? I have a job for you.", do:"Give a 'job': hold towel, watch kettle, fold cloth." },
          { say:"I'll be back in two minutes. Watch the timer for me.", do:"Use a timer + clear promise. Return when you say you will." },
          { say:"Thank you. You did great helping me.", do:"Praise the helper role. Repeat predictable routine." }
        ]},
        hygiene:{ title:"Refusing hygiene", steps:[
          { say:"No problem. We can do this gently.", do:"Remove pressure. Avoid 'you have to' language." },
          { say:"Would you like a warm cloth wash instead of a full wash?", do:"Offer a smaller option: face/hands first." },
          { say:"Do you want the bathroom warmer, or a towel warmed?", do:"Fix discomfort triggers: cold room, lighting, privacy." },
          { say:"That's enough for now. We'll stop there.", do:"Close early with success. Short wins beat battles." }
        ]},
        sundowning:{ title:"Sundowning", steps:[
          { say:"I can see you're feeling unsettled. I'm here.", do:"Acknowledge their distress. Don't dismiss or argue." },
          { say:"Let's turn on some lights and get cosy.", do:"Close curtains. Turn on more lights." },
          { say:"Would you like to sit with me for a bit?", do:"Gentle distraction: music, photo, simple activity." },
          { say:"You're safe. We'll get through the evening together.", do:"Stay calm. Predictable routine helps." }
        ]},
        wont_eat:{ title:"Won't eat", steps:[
          { say:"That's okay. No rush. We can try again later.", do:"Don't force. Remove pressure around mealtimes." },
          { say:"Would you like something small? Just a few bites?", do:"Offer finger foods, small portions, favourite tastes." },
          { say:"Let's sit together while I have mine.", do:"Eating together can encourage. Keep it social." },
          { say:"You did well. We'll have more later if you want.", do:"Praise any attempt. Make a quiet note for later." }
        ]},
        repetitive:{ title:"Repeating questions", steps:[
          { say:"That's a good question. Let me help.", do:"Answer as if it's the first time. Stay patient." },
          { say:"I'll write it down so we can check.", do:"Use a whiteboard or note to point to." },
          { say:"Let's do something together while we wait.", do:"Redirect to a simple activity or task." },
          { say:"I'm here. We're okay.", do:"Reassurance is what they need, not facts." }
        ]},
        aggression:{ title:"Aggression", steps:[
          { say:"I can see you're upset. I'm going to step back.", do:"Give space. Don't corner or crowd them." },
          { say:"You're safe. I'm here.", do:"Speak slowly. Sit down only if you can get up easily." },
          { say:"Let's take a breath together.", do:"Breathe slowly yourself. Wait for them to calm down." },
          { say:"Thank you. Let's sit down when you're ready.", do:"Don't hold grudges. Reset and move forward." }
        ]},
        sleep:{ title:"Sleep problems", steps:[
          { say:"Can't sleep? That's okay. Let's sit quietly.", do:"Don't argue about time. Join them calmly." },
          { say:"Would you like a warm drink or the radio on?", do:"Offer comfort. Dim lights. Keep voice soft." },
          { say:"We can rest here together for a bit.", do:"Don't force bed. Sitting nearby is fine." },
          { say:"You're safe. I'll be here if you need me.", do:"Reassure and let natural tiredness come." }
        ]},
        lost:{ title:"Lost / confused", steps:[
          { say:"You're safe with me.", do:"State location simply. Don't quiz or test them." },
          { say:"This is the kitchen.", do:"Point to familiar objects." },
          { say:"Let's go to your chair / your room.", do:"Guide to a familiar, comfortable spot." },
          { say:"You're home. I'm here with you.", do:"Reassurance matters more than facts." }
        ]},
        wandering:{ title:"Wandering", steps:[
          { say:"Where are we going? I'll walk with you.", do:"Don't block or grab. Walk alongside calmly." },
          { say:"Let's check together. What are you looking for?", do:"Make it a shared mission, not a confrontation." },
          { say:"It's cold/dark out there. Let's get a cup of tea first.", do:"Offer distraction before they reach the door." },
          { say:"You're safe here. Let's sit down for a moment.", do:"Guide gently back to a chair. Make sure doors are secure later." }
        ]},
        hiding:{ title:"Hiding things", steps:[
          { say:"I can see something's important to you.", do:"Don't accuse or demand. Stay calm and curious." },
          { say:"Can you show me where you put it?", do:"Let them lead. They may remember hiding spots." },
          { say:"Let's keep it safe together.", do:"Create a 'safe box' for important items." },
          { say:"Thank you for showing me.", do:"Don't make it a big deal. Note the hiding spots." }
        ]},
        undressing:{ title:"Undressing", steps:[
          { say:"Are you feeling too warm?", do:"Check temperature, clothing comfort, toileting needs." },
          { say:"Let's find something more comfortable.", do:"Offer loose, easy clothes they can manage." },
          { say:"Here. This will feel better.", do:"Redirect with a soft blanket or familiar item." },
          { say:"You're okay. Let's get comfy.", do:"Cover them gently. Move to a private room." }
        ]},
        rummaging:{ title:"Rummaging", steps:[
          { say:"What are you looking for? I can help.", do:"Join in rather than stopping them." },
          { say:"Let's check this drawer together.", do:"Redirect to a 'safe' drawer with harmless items." },
          { say:"I've put some things here for you to sort.", do:"Create a rummage box with safe objects." },
          { say:"Thank you for tidying.", do:"Make it purposeful. Praise their effort." }
        ]},
        hoarding:{ title:"Hoarding", steps:[
          { say:"That looks important. Tell me about it.", do:"Don't throw things away now." },
          { say:"Shall we find a special place for these?", do:"Offer a box or bag to 'keep things safe'." },
          { say:"Let's sort through together when you're ready.", do:"Remove items gradually, not all at once." },
          { say:"You've got some lovely things here.", do:"Validate their attachment. Be patient." }
        ]},
        crying:{ title:"Crying / tearful", steps:[
          { say:"I can see you're upset. I'm here.", do:"Sit close. Don't rush to fix or explain." },
          { say:"It's okay to feel this way.", do:"Validate the emotion even if cause is unclear." },
          { say:"Would you like a hug / hand to hold?", do:"Offer comfort. Physical touch if welcome." },
          { say:"I'm not going anywhere. Take your time.", do:"Be present. The feeling will pass." }
        ]},
        wont_get_up:{ title:"Won't get up", steps:[
          { say:"Good morning. No rush. Take your time.", do:"Don't force. Check if they're unwell or in pain." },
          { say:"Would you like a cup of tea in bed?", do:"Bring comfort to them first." },
          { say:"The bathroom's ready when you are.", do:"Give a gentle reason to move, not an order." },
          { say:"Let's just sit up for a bit.", do:"Small steps. Sitting up is progress." }
        ]},
        refusing_help:{ title:"Refusing help", steps:[
          { say:"That's okay. I'll be right over here.", do:"Step back. Don't argue or insist." },
          { say:"I'll be nearby if you change your mind.", do:"Give them space but stay available." },
          { say:"Can I help with just this one thing?", do:"Offer help with one tiny task only." },
          { say:"You're doing well. Let me know if you need me.", do:"Praise independence. Try again later." }
        ]},
        paranoid:{ title:"Paranoid", steps:[
          { say:"That sounds frightening. Tell me more.", do:"Listen without dismissing or arguing." },
          { say:"I can see why you're worried.", do:"Validate the feeling, not the belief." },
          { say:"Let's check together. I'll stay with you.", do:"Offer to investigate. Be their ally." },
          { say:"You're safe with me. I'm staying right here.", do:"Reassure. Reduce stimulation." }
        ]},
        hallucinations:{ title:"Seeing things", steps:[
          { say:"What can you see? Tell me about it.", do:"Stay calm. Don't argue or dismiss." },
          { say:"That must feel strange.", do:"Acknowledge their experience is real to them." },
          { say:"Let's turn on more lights / move rooms.", do:"Change environment. Reduce shadows." },
          { say:"I'm here with you. You're safe with me.", do:"Reassure. Don't pretend to see it too." }
        ]},
        inappropriate:{ title:"Inappropriate comments", steps:[
          { say:"Let's talk about something else.", do:"Redirect calmly. Don't shame or scold." },
          { say:"I know you don't mean to upset anyone.", do:"Assume good intent. They may not understand." },
          { say:"Come with me. I need your help.", do:"Move them away from the situation." },
          { say:"It's okay. Let's move on.", do:"Don't dwell. Apologise to others later if needed." }
        ]},
        wont_dress:{ title:"Won't get dressed", steps:[
          { say:"Let's take our time. No rush.", do:"Don't force. Check if clothes are uncomfortable." },
          { say:"Would you like to choose what to wear?", do:"Offer simple choices. Two options max." },
          { say:"Let's just put this on for now.", do:"One item at a time. Start with easiest piece." },
          { say:"You look nice. Well done.", do:"Praise any progress. Comfort over perfection." }
        ]},
        forgot_face:{ title:"Doesn't know me", steps:[
          { say:"Hello, I'm [name]. I'm here to help.", do:"Don't say 'Don't you remember me?' Stay calm." },
          { say:"We're friends. I've known you a long time.", do:"Reassure with warmth, not facts." },
          { say:"Let me show you some photos.", do:"Pictures may help. Don't quiz or test." },
          { say:"I care about you. That's what matters.", do:"Focus on feeling safe, not being recognised." }
        ]},
        fallback_not_sure:{ title:"Not sure what this is", steps:[
          { say:"Okay. We can slow down. I'm here with you.", do:"Speak quietly. Relax your shoulders." },
          { say:"What do you need right now?", do:"Ask one gentle question. Listen without rushing." },
          { say:"That's okay. We can sit quietly.", do:"If you feel unsafe or don't know what to do, tap Emergency." },
          { say:"We'll figure this out together.", do:"Stay with them. One moment at a time." }
        ]}
      };

      const URGENT_ITEMS = [
        { 
          key:"unresponsive", label:"Unresponsive", sub:"Won't wake up",
          keywords: ["unresponsive", "unconscious", "wake", "passed", "out", "fainted", "collapsed", "limp", "floppy", "not", "responding", "lifeless", "coma", "blackout", "knocked"],
          aliases: ["won't wake up", "passed out", "collapsed on floor", "not responding", "can't wake them", "fainted", "found unconscious", "not moving", "completely limp", "blacked out", "knocked out", "won't respond to voice", "eyes won't open"]
        },
        { 
          key:"breathing",    label:"Breathing trouble", sub:"Gasping / Choking",
          keywords: ["breathing", "breath", "choking", "choke", "gasp", "wheeze", "cough", "airway", "blue", "lips", "oxygen", "struggling", "suffocate", "throat", "swallow", "aspirate"],
          aliases: ["can't breathe", "struggling to breathe", "choking on food", "gasping for air", "gone blue", "lips are blue", "wheezing badly", "food stuck in throat", "trouble breathing", "short of breath", "breathing problems", "not breathing properly", "coughing and choking"]
        },
        { 
          key:"stroke",       label:"Stroke signs", sub:"Face, Arms, Speech",
          keywords: ["stroke", "face", "droop", "arm", "weak", "speech", "slur", "fast", "paralysis", "numbness", "side", "dizzy", "sudden", "confusion", "vision", "headache"],
          aliases: ["face drooping", "arm weakness", "slurred speech", "think it's a stroke", "can't lift arm", "face looks different", "one side weak", "sudden confusion", "FAST signs", "can't speak properly", "words not making sense", "stroke symptoms"]
        },
        { 
          key:"fall",         label:"Bad fall", sub:"Head injury / Pain",
          keywords: ["fall", "fell", "fallen", "head", "injury", "hurt", "pain", "hip", "fracture", "broken", "bleeding", "bump", "bruise", "floor", "stairs", "trip"],
          aliases: ["had a fall", "fell over", "hit their head", "fallen on floor", "can't get up after fall", "hurt after falling", "fell down stairs", "tripped and fell", "banged their head", "bleeding from fall", "possible fracture", "fell out of bed", "found on floor"]
        },
        { 
          key:"general_emergency", label:"Something feels seriously wrong", sub:"Need immediate help",
          keywords: ["emergency", "urgent", "ambulance", "danger", "unsafe", "serious", "help", "critical", "dying", "999", "112", "911"],
          aliases: ["need ambulance", "call ambulance", "this is an emergency", "urgent help now", "immediate danger", "something is seriously wrong", "can't cope", "can't handle this", "need help now", "feels very wrong", "i think they're dying"]
        }
      ];

      const URGENT_DECKS = {
        unresponsive:{ title:"Unresponsive", steps:[
          { say:null, do:"Call {EMERGENCY} now. Put phone on speaker. Follow operator instructions." },
          { say:null, do:"Check breathing. If not breathing normally, start CPR. If you're unsure, the {EMERGENCY} operator will tell you what to do." },
          { say:null, do:"If breathing, place in recovery position. Keep warm. Stay with them until help arrives." }
        ]},
        breathing:{ title:"Breathing trouble", steps:[
          { say:null, do:"If they can't speak or breathe, call {EMERGENCY} now. If you're worried at all, call {EMERGENCY} now. If they're coughing, let them cough." },
          { say:"I'm here with you. You're not alone.", do:"Help them sit upright. Loosen tight clothing. Open a window." },
          { say:null, do:"If they're still struggling to breathe, call {EMERGENCY} now. If you're unsure what to do, call for medical advice." }
        ]},
        stroke:{ title:"Stroke signs", steps:[
          { say:null, do:"Call {EMERGENCY} immediately. Note the time symptoms started." },
          { say:null, do:"Check FAST: Face drooping? Arm weak? Speech slurred? Call {EMERGENCY} now." },
          { say:"I'm here. Help is coming. Stay still.", do:"Do not give food or drink. Stay with them until help arrives." }
        ]},
        fall:{ title:"Bad fall", steps:[
          { say:"Don't try to move. I'm going to help you.", do:"If they hit their head, are bleeding, can't move, or you're worried at all, call {EMERGENCY} now." },
          { say:"Take your time. There's no rush.", do:"Check for pain, bleeding, alertness. Keep them warm and still." },
          { say:null, do:"If you're unsure what to do, call for medical advice. If they get worse at any point, call {EMERGENCY} now." }
        ]},
        general_emergency:{ title:"Something feels seriously wrong", steps:[
          { say:null, do:"Trust your instincts. If something feels seriously wrong, call {EMERGENCY} now." },
          { say:"I'm here with you. Help is on the way.", do:"Keep them warm and still. Talk calmly. Note any symptoms." },
          { say:null, do:"You're doing the right thing. It's always OK to call for help." }
        ]}
      };

      /* =========================
         RENDER
      ========================== */
      let showAllSituations = false;

      // Get situation keys excluding fallback
      function getSituationKeys(){
        return Object.keys(DATA).filter(k => !DATA[k].isFallback);
      }

      function renderHome(){
        const grid = document.getElementById("grid-container");
        const viewAllBtn = document.getElementById("view-all-btn");
        const keys = getSituationKeys();
        const total = keys.length;
        const visibleKeys = showAllSituations ? keys : keys.slice(0, VISIBLE_COUNT);

        // XSS-safe: use createElement + textContent instead of innerHTML
        grid.textContent = "";
        visibleKeys.forEach(k => {
          const item = DATA[k];
          const card = document.createElement("div");
          card.className = "card";
          card.setAttribute("role", "button");
          card.setAttribute("tabindex", "0");
          card.dataset.key = k;
          
          const title = document.createElement("div");
          title.className = "card-title";
          title.textContent = item.label;
          
          const sub = document.createElement("div");
          sub.className = "card-sub";
          sub.textContent = item.sub;
          
          card.appendChild(title);
          card.appendChild(sub);
          grid.appendChild(card);
        });

        // Show/hide "View all" button
        if(total > VISIBLE_COUNT){
          viewAllBtn.style.display = "block";
          if(showAllSituations){
            viewAllBtn.textContent = "Show fewer";
          } else {
            viewAllBtn.textContent = `View all ${total} situations`;
          }
        } else {
          viewAllBtn.style.display = "none";
        }
      }

      function toggleViewAll(){
        showAllSituations = !showAllSituations;
        renderHome();
      }

      /* =========================
         SEARCH / TYPEAHEAD
      ========================== */
      const SEARCH_THRESHOLD = 4;

      /* HARD EMERGENCY TOKENS - if any match, route to Emergency immediately */
      const EMERGENCY_TOKENS = {
        // Category 1: Breathing & consciousness
        breathing: ["not breathing", "cant breathe", "can't breathe", "breathing trouble", "gasping", "unconscious", "collapsed", "passed out", "unresponsive", "choking", "blue lips", "not responding", "wont wake", "won't wake", "fainted", "lifeless"],
        // Category 2: Stroke & heart
        stroke: ["stroke", "face drooping", "slurred speech", "heart attack", "chest pain", "arm pain", "sudden weakness", "sudden confusion", "fast test", "face droop", "one side weak"],
        // Category 3: Falls & injury
        injury: ["bad fall", "hit head", "head injury", "bleeding", "cant get up", "can't get up", "broken", "severe pain", "fracture", "found on floor"],
        // Category 4: Immediate danger
        danger: ["fire", "danger", "unsafe", "violent now", "aggressive now", "weapon", "threatening", "emergency", "ambulance", "999", "112", "dying", "immediate danger", "seriously wrong"]
      };
      
      /* =========================
         DEV-TIME LINT: Hardcoded emergency numbers
         Scans deck strings for 999/112/911 that should be {EMERGENCY}
      ========================== */
      function lintHardcodedEmergencyNumbers(){
        const hardcodedPattern = /\b(999|112|911)\b/g;
        const warnings = [];
        
        // Check CRISIS_DECKS
        for(const [key, deck] of Object.entries(CRISIS_DECKS)){
          deck.steps.forEach((step, i) => {
            if(step.say && hardcodedPattern.test(step.say)){
              warnings.push(`CRISIS_DECKS["${key}"].steps[${i}].say contains hardcoded number`);
            }
            hardcodedPattern.lastIndex = 0; // Reset regex
            if(step.do && hardcodedPattern.test(step.do)){
              warnings.push(`CRISIS_DECKS["${key}"].steps[${i}].do contains hardcoded number`);
            }
            hardcodedPattern.lastIndex = 0;
          });
        }
        
        // Check URGENT_DECKS
        for(const [key, deck] of Object.entries(URGENT_DECKS)){
          deck.steps.forEach((step, i) => {
            if(step.say && hardcodedPattern.test(step.say)){
              warnings.push(`URGENT_DECKS["${key}"].steps[${i}].say contains hardcoded number`);
            }
            hardcodedPattern.lastIndex = 0;
            // Note: {EMERGENCY} in do text is allowed and will be injected
            const doText = step.do || "";
            const cleanedDo = doText.replace(/\{EMERGENCY\}/g, ""); // Remove placeholders before checking
            if(hardcodedPattern.test(cleanedDo)){
              warnings.push(`URGENT_DECKS["${key}"].steps[${i}].do contains hardcoded number (use {EMERGENCY})`);
            }
            hardcodedPattern.lastIndex = 0;
          });
        }
        
        // Output warnings
        if(warnings.length > 0){
          console.warn("ð¨ DEV LINT: Hardcoded emergency numbers found:");
          warnings.forEach(w => console.warn("  â", w));
          console.warn("Replace hardcoded numbers with {EMERGENCY} placeholder.");
        }
      }

      function normalizeQuery(str){
        return str.toLowerCase().trim().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ');
      }

      /* Escape regex special characters */
      function escapeRegex(str){
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      /* Check if query contains emergency intent - returns true if ANY hard token matches */
      function hasEmergencyIntent(query){
        const q = normalizeQuery(query);
        if(!q) return false;
        
        for(const category of Object.values(EMERGENCY_TOKENS)){
          for(const token of category){
            // Multi-word phrases: use includes (safe, requires full phrase)
            // Single-word tokens: use word-boundary regex to prevent "fire" matching "fireplace"
            if(token.includes(' ')){
              if(q.includes(token)) return true;
            } else {
              const escaped = escapeRegex(token);
              const regex = new RegExp('\\b' + escaped + '\\b', 'i');
              if(regex.test(q)) return true;
            }
          }
        }
        return false;
      }

      /* Find which specific emergency items match the query */
      function matchEmergencyItems(query){
        const q = normalizeQuery(query);
        const matches = [];
        
        for(const item of URGENT_ITEMS){
          let score = 0;
          const label = normalizeQuery(item.label);
          const sub = normalizeQuery(item.sub);
          
          if(label.includes(q)) score += 6;
          if(sub.includes(q)) score += 4;
          
          if(item.aliases){
            for(const alias of item.aliases){
              if(normalizeQuery(alias).includes(q)){ score += 5; break; }
            }
          }
          if(item.keywords){
            for(const kw of item.keywords){
              const nkw = normalizeQuery(kw);
              if(nkw === q){ score += 3; break; }
              else if(nkw.includes(q) || q.includes(nkw)){ score += 2; }
            }
          }
          
          if(score > 0) matches.push({ key: item.key, score, isUrgent: true });
        }
        
        // Sort by score, return all matches (or general_emergency as fallback)
        matches.sort((a, b) => b.score - a.score);
        if(matches.length === 0){
          // Emergency intent detected but no specific match â general emergency
          return [{ key: 'general_emergency', score: 10, isUrgent: true }];
        }
        return matches;
      }

      function scoreItem(item, query){
        if(item.isFallback) return 0;
        
        let score = 0;
        const q = normalizeQuery(query);
        if(!q) return 0;
        
        const label = normalizeQuery(item.label);
        const sub = normalizeQuery(item.sub);
        
        if(label.includes(q)) score += 6;
        if(sub.includes(q)) score += 4;
        
        if(item.aliases){
          for(const alias of item.aliases){
            if(normalizeQuery(alias).includes(q)){ score += 5; break; }
          }
        }
        if(item.keywords){
          for(const kw of item.keywords){
            const nkw = normalizeQuery(kw);
            if(nkw === q){ score += 3; break; }
            else if(nkw.includes(q) || q.includes(nkw)){ score += 2; }
          }
        }
        
        return score;
      }

      const URGENT_THRESHOLD = 5; // Higher threshold for urgent to avoid false positives

      function searchSituations(query){
        const q = normalizeQuery(query);
        if(!q) return [];
        
        /* PRIORITY 1: Emergency intent check - if detected, return ONLY urgent items */
        if(hasEmergencyIntent(query)){
          return matchEmergencyItems(query);
        }
        
        /* PRIORITY 2: Score urgent items - only return if they genuinely match well */
        const urgentScored = URGENT_ITEMS.map(item => ({ key: item.key, score: scoreItem(item, query), isUrgent: true }))
                                         .filter(x => x.score > 0); // Filter out non-matches first
        urgentScored.sort((a, b) => b.score - a.score);
        
        // Only return urgent items if top score meets higher threshold
        if(urgentScored.length > 0 && urgentScored[0].score >= URGENT_THRESHOLD){
          return urgentScored;
        }
        
        /* PRIORITY 3: Normal crisis matching */
        const keys = getSituationKeys();
        const regularScored = keys.map(k => ({ key: k, score: scoreItem(DATA[k], query), isUrgent: false }))
                                  .filter(x => x.score > 0)
                                  .sort((a, b) => b.score - a.score);
        
        if(regularScored.length > 0 && regularScored[0].score >= SEARCH_THRESHOLD){
          return regularScored.slice(0, 5);
        }
        
        /* PRIORITY 4: Fallback */
        return [{ key: 'fallback_not_sure', score: 0, isUrgent: false }];
      }

      function renderSuggestions(results){
        const container = document.getElementById("search-suggestions");
        const homeSection = document.getElementById("common-home-section");
        
        if(results.length === 0){
          container.style.display = "none";
          homeSection.style.display = "block";
          return;
        }
        
        container.style.display = "flex";
        homeSection.style.display = "none";
        
        // XSS-safe: use createElement + textContent instead of innerHTML
        container.textContent = "";
        results.forEach(r => {
          let item;
          if(r.isUrgent){
            item = URGENT_ITEMS.find(u => u.key === r.key);
          } else {
            item = DATA[r.key];
          }
          if(!item) return;
          
          const card = document.createElement("div");
          card.className = r.isUrgent ? "card urgent-suggestion" : "card";
          card.setAttribute("role", "button");
          card.setAttribute("tabindex", "0");
          card.dataset.key = r.key;
          card.dataset.urgent = r.isUrgent;
          
          const title = document.createElement("div");
          title.className = "card-title";
          title.textContent = item.label;
          
          const sub = document.createElement("div");
          sub.className = "card-sub";
          sub.textContent = item.sub;
          
          card.appendChild(title);
          card.appendChild(sub);
          container.appendChild(card);
        });
      }

      function handleSearchInput(e){
        const query = e.target.value;
        if(query.trim().length === 0){
          renderSuggestions([]);
        } else {
          const results = searchSituations(query);
          renderSuggestions(results);
        }
      }

      function renderUrgentSheet(){
        const list = document.getElementById("urgent-grid-sheet");
        // XSS-safe: use createElement + textContent instead of innerHTML
        list.textContent = "";
        URGENT_ITEMS.forEach(it => {
          const row = document.createElement("div");
          row.className = "urgent-row";
          row.setAttribute("role", "button");
          row.setAttribute("tabindex", "0");
          row.dataset.urgent = it.key;
          
          const inner = document.createElement("div");
          
          const label = document.createElement("div");
          label.style.cssText = "font-weight:500;font-size:19px;line-height:1.35;margin-bottom:4px;";
          label.textContent = it.label;
          
          const sub = document.createElement("div");
          sub.style.cssText = "font-size:15px;color:var(--text-muted);line-height:1.4;";
          sub.textContent = it.sub;
          
          inner.appendChild(label);
          inner.appendChild(sub);
          row.appendChild(inner);
          list.appendChild(row);
        });
      }

      /* =========================
         OVERLAYS
      ========================== */
      function isOpen(id){
        const el = document.getElementById(id);
        return !!el && el.classList.contains("active");
      }

      // Centralized body lock - considers ALL overlays
      function updateBodyLock(){
        const anyOpen = 
          isOpen("stepdown-overlay") || 
          isOpen("urgent-overlay") || 
          isOpen("info-overlay") ||
          isResumePromptOpen();
        document.body.style.overflow = anyOpen ? "hidden" : "";
      }

      /* =========================
         HISTORY MANAGEMENT (Android back button)
      ========================== */
      let historyStatePushed = false;
      
      function pushOverlayState(){
        if(!historyStatePushed){
          history.pushState({ overlay: true }, "");
          historyStatePushed = true;
        }
      }
      
      function clearOverlayState(){
        // Only clear flag; don't manipulate history directly
        historyStatePushed = false;
      }
      
      function hasAnyOverlayOpen(){
        return isOpen("stepdown-overlay") || isOpen("urgent-overlay") || isOpen("info-overlay") || isResumePromptOpen() || isOpen("followup-overlay") || isOpen("followup-response-overlay");
      }

      function toggleUrgent(show){
        const el = document.getElementById("urgent-overlay");
        if(!el) return;
        
        // Note: emergencyUsed is set only when a call is initiated (callEmergency/callAdvice)
        // Opening the panel alone does NOT count as "used"
        if(!show && emergencyUsed){
          // Show reassurance on close only if a call was actually initiated
          showReassurance();
          emergencyUsed = false;
        }
        
        if(show) pushOverlayState();
        
        if(!show) document.getElementById("urgent-open")?.focus();
        el.classList.toggle("active", !!show);
        el.setAttribute("aria-hidden", show ? "false" : "true");
        updateBodyLock();
        
        // Check after toggle if we should clear history state
        if(!show && !hasAnyOverlayOpen()) clearOverlayState();
        if(show) document.getElementById("urgent-close")?.focus();
      }
      
      // Show brief reassurance banner after emergency use
      function showReassurance(){
        const banner = document.getElementById("reassurance-banner");
        if(!banner) return;
        banner.style.display = "block";
        // Auto-hide after 6 seconds
        setTimeout(() => { banner.style.display = "none"; }, 6000);
      }
      
      // Toast notification (replaces native alert)
      let toastTimeout = null;
      function showToast(message, duration = 3000){
        const toast = document.getElementById("toast");
        if(!toast) return;
        toast.textContent = message;
        toast.classList.add("show");
        if(toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
          toast.classList.remove("show");
        }, duration);
      }

      function toggleInfo(show){
        const el = document.getElementById("info-overlay");
        if(!el) return;
        
        if(show) pushOverlayState();
        
        if(!show) document.getElementById("info-open")?.focus();
        el.classList.toggle("active", !!show);
        el.setAttribute("aria-hidden", show ? "false" : "true");
        updateBodyLock();
        if(show) document.getElementById("info-close")?.focus();
        
        // Check after toggle if we should clear history state
        if(!show && !hasAnyOverlayOpen()) clearOverlayState();
      }

      function toggleStepdown(show){
        const el = document.getElementById("stepdown-overlay");
        if(!el) return;
        
        if(show) pushOverlayState();
        
        if(!show){
          stopSpeak();
          document.getElementById("query")?.focus();
        }
        el.classList.toggle("active", !!show);
        el.setAttribute("aria-hidden", show ? "false" : "true");
        updateBodyLock();
        if(show) document.getElementById("stepdown-close")?.focus();
        
        // Check after toggle if we should clear history state
        if(!show && !hasAnyOverlayOpen()) clearOverlayState();
      }

      /* =========================
         STEP FLOW (single engine)
      ========================== */
      let activeDecks = null;   // CRISIS_DECKS or URGENT_DECKS
      let activeKey = null;
      let stepIndex = 0;

      // Resume grace: remember last position for 10 minutes (CRISIS decks only)
      let resumeState = { 
        deckKey: null,      // The situation key (e.g., "refusing_meds")
        stepIndex: 0,       // Which step they were on
        timestamp: 0        // When they exited
      };
      
      // Urgent resume: shorter TTL, separate from crisis (5 minutes)
      let urgentResumeState = {
        deckKey: null,
        stepIndex: 0,
        timestamp: 0
      };
      const URGENT_RESUME_MS = 5 * 60 * 1000; // 5 minutes for urgent
      
      const RESUME_GRACE_MS = 10 * 60 * 1000; // 10 minutes
      const RESUME_MIN_TIME_MS = 5 * 1000;    // Must be in deck 5+ seconds to save resume
      let deckOpenedAt = 0;                   // Timestamp when deck was opened
      
      // Emergency action tracking
      let emergencyUsed = false;        // For reassurance banner
      let emergencyTriggeredSinceExit = false; // Blocks resume if emergency was used

      /* EXIT DECK: Single function for all exits. Returns to Home/List reliably.
         No completion screens, no confirmations, no shame language. */
      function exitDeck(wasCompleted = false){
        // Guard: only true if explicitly passed boolean true (prevents Event object bugs)
        wasCompleted = (wasCompleted === true);
        stopSpeak();
        
        const timeInDeck = Date.now() - deckOpenedAt;
        
        // Save CRISIS resume state (mid-flow, not completed, not step 1, 5+ seconds)
        if(activeDecks === CRISIS_DECKS && activeKey && !wasCompleted && stepIndex > 0 && timeInDeck >= RESUME_MIN_TIME_MS){
          resumeState = { 
            deckKey: activeKey, 
            stepIndex: stepIndex, 
            timestamp: Date.now()
          };
        } else if(activeDecks === CRISIS_DECKS && wasCompleted){
          clearResume();
        }
        
        // Save URGENT resume state (mid-flow, not completed, shorter TTL)
        if(activeDecks === URGENT_DECKS && activeKey && !wasCompleted && stepIndex > 0){
          urgentResumeState = {
            deckKey: activeKey,
            stepIndex: stepIndex,
            timestamp: Date.now()
          };
        } else if(activeDecks === URGENT_DECKS && wasCompleted){
          clearUrgentResume();
        }
        
        activeDecks = null;
        activeKey = null;
        stepIndex = 0;
        
        // Clear search UI so home state is clean
        const searchInput = document.getElementById("query");
        if(searchInput) searchInput.value = "";
        renderSuggestions([]);
        
        toggleStepdown(false);
        
        // Update home screen continue chip
        updateContinueChip();
      }
      
      /* =========================
         POST-COMPLETION FOLLOW-UP
      ========================== */
      function showFollowup(){
        const overlay = document.getElementById("followup-overlay");
        overlay.classList.add("active");
        overlay.setAttribute("aria-hidden", "false");
        document.getElementById("followup-calmer")?.focus();
      }
      
      function hideFollowup(){
        const overlay = document.getElementById("followup-overlay");
        overlay.classList.remove("active");
        overlay.setAttribute("aria-hidden", "true");
      }
      
      function showFollowupResponse(type){
        hideFollowup();
        
        const overlay = document.getElementById("followup-response-overlay");
        const textEl = document.getElementById("followup-response-text");
        const buttonsEl = document.getElementById("followup-response-buttons");
        
        buttonsEl.textContent = "";
        
        if(type === "calmer"){
          textEl.textContent = "That's good to hear.";
          textEl.style.marginBottom = "0"; // No buttons, so remove bottom margin
          // Make card look like outline button (transparent + border)
          const card = overlay.querySelector(".followup-card");
          card.classList.add("followup-card-minimal");
          // Auto-dismiss after 2 seconds
          setTimeout(() => {
            card.classList.remove("followup-card-minimal");
            closeFollowupAndExit();
          }, 2000);
        } else if(type === "same"){
          textEl.textContent = "Would you like more help?";
          textEl.style.marginBottom = "32px"; // More space before buttons
          
          const btn1 = document.createElement("button");
          btn1.className = "pill pill-outline";
          btn1.style.cssText = "width:100%;height:56px;font-size:16px;";
          btn1.textContent = "Try another situation";
          btn1.onclick = () => closeFollowupAndExit();
          buttonsEl.appendChild(btn1);
          
          const btn2 = document.createElement("button");
          btn2.className = "pill pill-outline";
          btn2.style.cssText = "width:100%;height:56px;font-size:16px;";
          btn2.textContent = "Stay here";
          btn2.onclick = () => {
            hideFollowupResponse();
            // Stay on current step (user stays in card)
          };
          buttonsEl.appendChild(btn2);
        } else if(type === "worse"){
          textEl.textContent = "If things are getting worse, it's okay to get urgent help.";
          textEl.style.marginBottom = "32px"; // More space before buttons
          
          // Emergency call button
          const btn1 = document.createElement("button");
          btn1.className = "pill emergency-call-btn";
          btn1.style.cssText = "width:100%;height:56px;font-size:17px;";
          btn1.textContent = `Call ${emergencyNumber}`;
          btn1.onclick = () => {
            hideFollowupResponse();
            exitDeck(true);
            callEmergency();
          };
          buttonsEl.appendChild(btn1);
          
          // NHS 111 / Medical advice (UK only)
          if(emergencyNumber === "999"){
            const btn2 = document.createElement("button");
            btn2.className = "pill nhs-advice-btn";
            btn2.style.cssText = "width:100%;height:56px;font-size:17px;";
            btn2.textContent = "Call NHS 111";
            btn2.onclick = () => {
              hideFollowupResponse();
              exitDeck(true);
              callAdvice();
            };
            buttonsEl.appendChild(btn2);
          }
          
          // Back to situations
          const btn3 = document.createElement("button");
          btn3.className = "pill pill-outline";
          btn3.style.cssText = "width:100%;height:56px;font-size:16px;";
          btn3.textContent = "Back to situations";
          btn3.onclick = () => closeFollowupAndExit();
          buttonsEl.appendChild(btn3);
        }
        
        overlay.classList.add("active");
        overlay.setAttribute("aria-hidden", "false");
      }
      
      function hideFollowupResponse(){
        const overlay = document.getElementById("followup-response-overlay");
        overlay.classList.remove("active");
        overlay.setAttribute("aria-hidden", "true");
      }
      
      function closeFollowupAndExit(){
        hideFollowup();
        hideFollowupResponse();
        exitDeck(true);
      }
      
      // Check if resume should be offered
      // ONLY for CRISIS decks, same key, within TTL, not after emergency
      function canResume(decks, key){
        // Rule: Never for URGENT decks
        if(decks === URGENT_DECKS) return false;
        
        // Rule: Must be CRISIS deck
        if(decks !== CRISIS_DECKS) return false;
        
        // Rule: Must have saved state
        if(!resumeState.deckKey) return false;
        
        // Rule: Must be same situation
        if(resumeState.deckKey !== key) return false;
        
        // Rule: Must be within 10 minutes
        if(Date.now() - resumeState.timestamp > RESUME_GRACE_MS) return false;
        
        // Rule: Must have been past step 1
        if(resumeState.stepIndex === 0) return false;
        
        // Rule: Must not have used emergency since exit
        if(emergencyTriggeredSinceExit) return false;
        
        return true;
      }
      
      // Clear resume memory (called after user chooses, or on completion)
      function clearResume(){
        resumeState = { deckKey: null, stepIndex: 0, timestamp: 0 };
        emergencyTriggeredSinceExit = false;
        updateContinueChip(); // Update home screen chip
      }
      
      // Clear urgent resume (on call placed or completion)
      function clearUrgentResume(){
        urgentResumeState = { deckKey: null, stepIndex: 0, timestamp: 0 };
        updateContinueChip();
      }
      
      // Check if CRISIS resume is available
      function hasCrisisResumeAvailable(){
        if(!resumeState.deckKey) return false;
        if(Date.now() - resumeState.timestamp > RESUME_GRACE_MS) return false;
        if(resumeState.stepIndex === 0) return false;
        if(emergencyTriggeredSinceExit) return false;
        return true;
      }
      
      // Check if URGENT resume is available
      function hasUrgentResumeAvailable(){
        if(!urgentResumeState.deckKey) return false;
        if(Date.now() - urgentResumeState.timestamp > URGENT_RESUME_MS) return false;
        if(urgentResumeState.stepIndex === 0) return false;
        return true;
      }
      
      // Legacy alias
      function hasResumeAvailable(){ return hasCrisisResumeAvailable(); }
      
      // Update home screen continue chip (shows either crisis or urgent resume)
      function updateContinueChip(){
        const chip = document.getElementById("continue-chip");
        const label = document.getElementById("continue-label");
        const detail = document.getElementById("continue-detail");
        if(!chip) return;
        
        // Priority: show urgent resume first (more time-critical)
        if(hasUrgentResumeAvailable()){
          const deck = URGENT_DECKS[urgentResumeState.deckKey];
          if(deck){
            label.textContent = "Return to emergency";
            detail.textContent = `${deck.title} Â· Step ${urgentResumeState.stepIndex + 1}`;
            chip.dataset.resumeType = "urgent";
            chip.style.display = "block";
            return;
          }
        }
        
        // Otherwise show crisis resume
        if(hasCrisisResumeAvailable()){
          const deck = CRISIS_DECKS[resumeState.deckKey];
          if(deck){
            label.textContent = "Continue where you left off";
            detail.textContent = `${deck.title} Â· Step ${resumeState.stepIndex + 1}`;
            chip.dataset.resumeType = "crisis";
            chip.style.display = "block";
            return;
          }
        }
        
        chip.style.display = "none";
      }
      
      // Resume prompt state
      let resumePromptCallbacks = { onContinue: null, onRestart: null };
      
      // Single cleanup function for resume prompt (used by all close paths)
      function cleanupResumePrompt(){
        const overlay = document.getElementById("resume-overlay");
        const continueBtn = document.getElementById("resume-continue");
        const restartBtn = document.getElementById("resume-restart");
        
        overlay.classList.remove("active");
        overlay.setAttribute("aria-hidden", "true");
        updateBodyLock(); // Centralized body lock
        
        continueBtn.onclick = null;
        restartBtn.onclick = null;
        resumePromptCallbacks.onContinue = null;
        resumePromptCallbacks.onRestart = null;
      }
      
      // Show in-app resume prompt (replaces native confirm)
      function showResumePrompt(stepNum, onContinue, onRestart){
        const overlay = document.getElementById("resume-overlay");
        const stepEl = document.getElementById("resume-step");
        const continueBtn = document.getElementById("resume-continue");
        const restartBtn = document.getElementById("resume-restart");
        
        // Store callbacks
        resumePromptCallbacks.onContinue = onContinue;
        resumePromptCallbacks.onRestart = onRestart;
        
        stepEl.textContent = `Step ${stepNum}`;
        overlay.classList.add("active");
        overlay.setAttribute("aria-hidden", "false");
        updateBodyLock(); // Centralized body lock
        
        continueBtn.focus();
        
        continueBtn.onclick = () => { 
          const cb = resumePromptCallbacks.onContinue;
          cleanupResumePrompt(); 
          if(cb) cb(); 
        };
        restartBtn.onclick = () => { 
          const cb = resumePromptCallbacks.onRestart;
          cleanupResumePrompt(); 
          if(cb) cb(); 
        };
      }
      
      // Check if resume prompt is open
      function isResumePromptOpen(){
        const overlay = document.getElementById("resume-overlay");
        return overlay?.classList.contains("active");
      }
      
      // Dismiss resume prompt (ESC/backdrop: defaults to Start from Step 1)
      function dismissResumePrompt(){
        if(!isResumePromptOpen()) return;
        const cb = resumePromptCallbacks.onRestart;
        cleanupResumePrompt();
        if(cb) cb();
      }

      /* OPEN DECK: Always resets state to ensure fresh start.
         - stepIndex reset to 0
         - previous card content cleared via new activeDecks/activeKey
         - step indicator will show "Step 1 of N" for the new card */
      function openDeck(decks, key, forceStep){
        if(!decks[key]) return;
        
        // Clear old urgent resume if switching to a different urgent situation
        // "Latest intent wins" â the app always reflects the current emergency
        if(decks === URGENT_DECKS && urgentResumeState.deckKey && urgentResumeState.deckKey !== key){
          clearUrgentResume();
        }
        
        // URGENT decks: Never show resume prompt, start immediately
        if(decks === URGENT_DECKS){
          activeDecks = decks;
          activeKey = key;
          stepIndex = forceStep !== undefined ? forceStep : 0;
          finishOpenDeck(decks);
          return;
        }
        
        // CRISIS decks: Check for resume only if clicking same card
        if(forceStep === undefined && canResume(decks, key)){
          const savedStep = resumeState.stepIndex;
          const resumeStepHuman = savedStep + 1; // Human-readable (1-indexed)
          
          showResumePrompt(resumeStepHuman, 
            () => {
              // Continue from saved step
              activeDecks = decks;
              activeKey = key;
              stepIndex = savedStep;
              clearResume();
              finishOpenDeck(decks);
            },
            () => {
              // Start from step 1
              activeDecks = decks;
              activeKey = key;
              stepIndex = 0;
              clearResume();
              finishOpenDeck(decks);
            }
          );
          return;
        }
        
        // Normal open (no resume available or forceStep specified)
        if(forceStep !== undefined){
          activeDecks = decks;
          activeKey = key;
          stepIndex = forceStep;
        } else {
          activeDecks = decks;
          activeKey = key;
          stepIndex = 0;
        }
        
        finishOpenDeck(decks);
      }
      
      function finishOpenDeck(decks){
        // Track when deck was opened (for minimum time threshold)
        deckOpenedAt = Date.now();
        
        // Show call button for urgent decks
        const callBtn = document.getElementById("stepdown-call");
        const callLabel = document.getElementById("stepdown-call-label");
        if(decks === URGENT_DECKS){
          callBtn.style.display = "block";
          callLabel.textContent = `Call ${emergencyNumber}`;
        } else {
          callBtn.style.display = "none";
        }
        
        renderStep();
        toggleStepdown(true);
      }

      function renderStep(){
        const deck = activeDecks?.[activeKey];
        if(!deck) return;
        
        // BOUNDS SAFETY: If stepIndex somehow out of range, exit safely
        if(stepIndex < 0 || stepIndex >= deck.steps.length){
          exitDeck();
          return;
        }

        const step = deck.steps[stepIndex];
        const isUrgent = activeDecks === URGENT_DECKS;
        
        document.getElementById("stepdown-title").textContent = deck.title;
        document.getElementById("stepdown-progress").textContent = `Step ${stepIndex+1} of ${deck.steps.length}`;
        
        // SAY section: Show only if step.say exists and is non-empty
        const saySection = document.getElementById("stepdown-say-section");
        const sayText = document.getElementById("stepdown-say");
        const doKicker = document.getElementById("stepdown-do-kicker");
        const doText = document.getElementById("stepdown-do");
        
        if(step.say){
          saySection.style.display = "block";
          sayText.textContent = injectEmergencyNumber(step.say);
          doKicker.textContent = "You can do this";
          doText.classList.remove("do-only");
        } else {
          saySection.style.display = "none";
          doKicker.textContent = "Do this";
          doText.classList.add("do-only");  // Largest text in app for DO-only steps
        }
        
        // DO section: Render with inline tappable emergency for urgent, plain text otherwise
        if(isUrgent && step.do && step.do.includes("{EMERGENCY}")){
          renderDoWithInlineEmergency(doText, step.do);
        } else {
          doText.textContent = injectEmergencyNumber(step.do) || "";
        }
        
        // Button visibility: Toggle controls based on deck type
        const genericEmergencyBtn = document.getElementById("stepdown-emergency");
        const backToUrgent = document.getElementById("back-to-urgent");
        const backToSituations = document.getElementById("back-to-situations");
        const listenFooter = document.getElementById("listen-btn");
        const listenInline = document.getElementById("listen-inline");
        
        // Listen is always inline (under SAY text) for both deck types
        if(listenFooter) listenFooter.style.display = "none";
        if(listenInline) listenInline.style.display = "inline-flex";
        
        if(isUrgent){
          // Urgent deck: Call button, no Emergency button
          genericEmergencyBtn.style.display = "none";
          if(backToUrgent) backToUrgent.style.display = "block";
          if(backToSituations) backToSituations.style.display = "none";
        } else {
          // Crisis deck: Emergency button + hint
          genericEmergencyBtn.style.display = "block";
          if(backToUrgent) backToUrgent.style.display = "none";
          if(backToSituations) backToSituations.style.display = "block";
        }

        const back = document.getElementById("stepdown-back");
        const next = document.getElementById("stepdown-next");
        
        // Back disabled at first step (visual only - prevStep handles exit)
        back.disabled = false;  // Keep enabled so it can exit
        back.style.opacity = stepIndex === 0 ? "0.5" : "1";

        const isLast = stepIndex === deck.steps.length - 1;
        next.textContent = isLast ? "Done" : "Next";

        stopSpeak(); // stop speech when step changes
      }

      function nextStep(){
        const deck = activeDecks?.[activeKey];
        if(!deck) return;
        
        if(stepIndex < deck.steps.length - 1){
          stepIndex++;
          renderStep();
        } else {
          // LAST STEP: Show follow-up for CRISIS decks, direct exit for URGENT
          if(activeDecks === CRISIS_DECKS){
            showFollowup();
          } else {
            exitDeck(true); // wasCompleted = true, clears resume state
          }
        }
      }

      function prevStep(){
        if(stepIndex > 0){
          stepIndex--;
          renderStep();
        } else {
          // FIRST STEP: Back exits to home/list
          exitDeck();
        }
      }

      /* =========================
         TEXT-TO-SPEECH (Speaker)
      ========================== */
      let speaking = false;
      let preferredVoice = null;

      function pickVoice(){
        try{
          const voices = window.speechSynthesis?.getVoices?.() || [];
          preferredVoice =
            voices.find(v => /en-GB/i.test(v.lang)) ||
            voices.find(v => /en/i.test(v.lang)) ||
            voices[0] || null;
        }catch(_){}
      }

      function updateListenUI(){
        // Footer listen button (urgent mode)
        const btn = document.getElementById("listen-btn");
        if(btn){
        btn.classList.toggle("speaking", speaking);
        btn.setAttribute("aria-label", speaking ? "Stop listening" : "Listen to this step");
        const label = btn.querySelector(".listen-label");
        if(label) label.textContent = speaking ? "Stop" : "Listen";
        }
        // Inline listen button (crisis mode)
        const inlineBtn = document.getElementById("listen-inline");
        if(inlineBtn){
          inlineBtn.classList.toggle("speaking", speaking);
          inlineBtn.setAttribute("aria-label", speaking ? "Stop listening" : "Listen to this step");
          const inlineLabel = inlineBtn.querySelector(".listen-inline-label");
          if(inlineLabel) inlineLabel.textContent = speaking ? "Stop" : "Listen";
        }
      }

      function stopSpeak(){
        if("speechSynthesis" in window){
          window.speechSynthesis.cancel();
        }
        speaking = false;
        updateListenUI();
      }

      function speakCurrent(){
        const deck = activeDecks?.[activeKey];
        if(!deck) return;

        if(!("speechSynthesis" in window)){
          showToast("Text-to-speech isn't available in this browser.");
          return;
        }

        if(speaking){
          stopSpeak();
          return;
        }

        const step = deck.steps[stepIndex];
        const sayPart = step.say ? `Words to say: ${injectEmergencyNumber(step.say)}. ` : "";
        const doPart = injectEmergencyNumber(step.do);
        const text = `${deck.title}. Step ${stepIndex+1}. ${sayPart}Do this: ${doPart}`;

        const u = new SpeechSynthesisUtterance(text);
        u.rate = 0.95;
        u.pitch = 1.0;
        if(preferredVoice) u.voice = preferredVoice;

        u.onend = () => { speaking = false; updateListenUI(); };
        u.onerror = () => { speaking = false; updateListenUI(); };

        speaking = true;
        updateListenUI();

        // cancel + speak in next tick for reliability
        window.speechSynthesis.cancel();
        setTimeout(() => window.speechSynthesis.speak(u), 0);
      }

      /* =========================
         VOICE INPUT (Mic) - optional
      ========================== */
      let recognition = null;
      let listening = false;

      function initSpeechRecognition(){
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SR) return;

        recognition = new SR();
        recognition.lang = "en-GB";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onresult = (event) => {
          const txt = event.results?.[0]?.[0]?.transcript?.trim?.() || "";
          const input = document.getElementById("query");
          if(input && txt){
            input.value = txt;
            // Trigger search
            const results = searchSituations(txt);
            renderSuggestions(results);
          }
        };

        recognition.onend = () => {
          listening = false;
          document.getElementById("mic-btn")?.classList.remove("listening");
        };
      }

      function toggleMic(){
        if(!recognition){
          showToast("Voice input isn't available on this device.");
          return;
        }
        const mic = document.getElementById("mic-btn");

        if(listening){
          recognition.stop();
          listening = false;
          mic?.classList.remove("listening");
          return;
        }

        listening = true;
        mic?.classList.add("listening");
        recognition.start();
      }

      /* =========================
         TEL buttons (Emergency)
      ========================== */
      let emergencyNumber = "999";
      let adviceNumber = "111";
      let isUK = true;

      function detectRegion(){
        try {
          const lang = navigator.language || navigator.userLanguage || "";
          const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
          isUK = lang.toLowerCase().includes("gb") || 
                 lang.toLowerCase() === "en-gb" || 
                 tz.toLowerCase().includes("london") ||
                 tz.toLowerCase().includes("europe/london");
        } catch(e) {
          isUK = true; // Default to UK if detection fails
        }
        
        if (isUK) {
          emergencyNumber = "999";
          adviceNumber = "111";
        } else {
          emergencyNumber = "112";
          adviceNumber = null; // Hide advice button for non-UK
        }
      }

      function setupEmergencyPanel(){
        detectRegion();
        
        const emergencyBtn = document.getElementById("call-emergency");
        const adviceBtn = document.getElementById("call-advice");
        const emergencyNumEl = document.getElementById("emergency-number");
        const adviceNumEl = document.getElementById("advice-number");
        const emergencyHint = document.getElementById("emergency-hint");
        
        // Populate call button labels
        emergencyNumEl.textContent = `Call ${emergencyNumber}`;
        if(adviceNumEl && adviceNumber){
          adviceNumEl.textContent = `NHS ${adviceNumber}`;
        }
        
        // Inject emergency number into hint text
        if(emergencyHint){
          emergencyHint.textContent = injectEmergencyNumber("If you or they are in immediate danger, call {EMERGENCY} now.");
        }
        
        // Update info panel emergency line
        const infoEmergencyLine = document.getElementById("info-emergency-line");
        if(infoEmergencyLine){
          infoEmergencyLine.textContent = injectEmergencyNumber("If you or they are in immediate danger, call {EMERGENCY} now.");
        }
        
        // Hide advice button for non-UK (no universal equivalent)
        if (!isUK || !adviceNumber) {
          adviceBtn.style.display = "none";
          emergencyBtn.style.flex = "1";
        }
      }

      function callEmergency(){
        emergencyUsed = true;               // Show reassurance after closing emergency panel
        emergencyTriggeredSinceExit = true; // Block crisis resume after call
        clearUrgentResume();                // Clear urgent resume on call placed
        window.location.href = `tel:${emergencyNumber}`;
      }

      function callAdvice(){
        if (adviceNumber) {
          emergencyUsed = true;               // Show reassurance after closing emergency panel
          emergencyTriggeredSinceExit = true; // Block crisis resume after advice call too
          clearUrgentResume();                // Clear urgent resume on call placed
          window.location.href = `tel:${adviceNumber}`;
        }
      }

      /* Inject region-safe emergency number into copy strings */
      function injectEmergencyNumber(text){
        if(!text) return text;
        return text.replace(/\{EMERGENCY\}/g, emergencyNumber);
      }

      /* Render DO text with inline tappable emergency number (for urgent decks)
         Only the FIRST {EMERGENCY} is tappable; subsequent ones are plain text */
      function renderDoWithInlineEmergency(containerEl, text){
        if(!containerEl) return;
        containerEl.innerHTML = "";
        if(!text) return;
        
        // Check if {EMERGENCY} exists in text
        if(!text.includes("{EMERGENCY}")){
          containerEl.textContent = text;
          return;
        }
        
        // Split by {EMERGENCY} and build nodes
        const parts = text.split("{EMERGENCY}");
        let firstChipRendered = false;
        
        parts.forEach((part, i) => {
          // Add text part
          if(part){
            containerEl.appendChild(document.createTextNode(part));
          }
          // Add chip/text (except after last part)
          if(i < parts.length - 1){
            if(!firstChipRendered){
              // First occurrence: tappable button
              const chip = document.createElement("button");
              chip.type = "button";
              chip.className = "inline-call";
              chip.textContent = emergencyNumber;
              chip.setAttribute("aria-label", `Call ${emergencyNumber}`);
              chip.addEventListener("click", callEmergency);
              containerEl.appendChild(chip);
              firstChipRendered = true;
            } else {
              // Subsequent occurrences: plain text
              containerEl.appendChild(document.createTextNode(emergencyNumber));
            }
          }
        });
      }

      /* =========================
         WIRING
      ========================== */
      function wire(){
        // search input
        const searchInput = document.getElementById("query");
        searchInput.addEventListener("input", handleSearchInput);
        
        // search suggestions clicks
        const suggestions = document.getElementById("search-suggestions");
        suggestions.addEventListener("click", (e) => {
          const card = e.target.closest(".card");
          if(!card) return;
          const isUrgent = card.dataset.urgent === "true";
          openDeck(isUrgent ? URGENT_DECKS : CRISIS_DECKS, card.dataset.key);
          searchInput.value = "";
          renderSuggestions([]);
        });
        suggestions.addEventListener("keydown", (e) => {
          if(e.key !== "Enter" && e.key !== " ") return;
          const card = e.target.closest(".card");
          if(!card) return;
          e.preventDefault();
          const isUrgent = card.dataset.urgent === "true";
          openDeck(isUrgent ? URGENT_DECKS : CRISIS_DECKS, card.dataset.key);
          searchInput.value = "";
          renderSuggestions([]);
        });

        // home tiles (no input flicker)
        const grid = document.getElementById("grid-container");
        grid.addEventListener("click", (e) => {
          const card = e.target.closest(".card");
          if(!card) return;
          openDeck(CRISIS_DECKS, card.dataset.key);
        });
        grid.addEventListener("keydown", (e) => {
          if(e.key !== "Enter" && e.key !== " ") return;
          const card = e.target.closest(".card");
          if(!card) return;
          e.preventDefault();
          openDeck(CRISIS_DECKS, card.dataset.key);
        });

        // urgent open/close
        document.getElementById("urgent-open").addEventListener("click", () => toggleUrgent(true));
        document.getElementById("urgent-close").addEventListener("click", () => toggleUrgent(false));
        document.getElementById("urgent-overlay").addEventListener("click", (e) => {
          if(e.target.id === "urgent-overlay") toggleUrgent(false);
        });

        // urgent rows -> open urgent decks (FIXED)
        const urgentList = document.getElementById("urgent-grid-sheet");
        urgentList.addEventListener("click", (e) => {
          const row = e.target.closest(".urgent-row");
          if(!row) return;
          toggleUrgent(false);
          openDeck(URGENT_DECKS, row.dataset.urgent);
        });
        urgentList.addEventListener("keydown", (e) => {
          if(e.key !== "Enter" && e.key !== " ") return;
          const row = e.target.closest(".urgent-row");
          if(!row) return;
          e.preventDefault();
          toggleUrgent(false);
          openDeck(URGENT_DECKS, row.dataset.urgent);
        });

        // stepdown controls
        document.getElementById("stepdown-next").addEventListener("click", nextStep);
        document.getElementById("stepdown-back").addEventListener("click", prevStep);
        document.getElementById("stepdown-close").addEventListener("click", () => exitDeck()); // Close = exit to home
        document.getElementById("switch-situation").addEventListener("click", () => exitDeck()); // Switch = exit to home (resume still saved)
        document.getElementById("back-to-urgent-btn").addEventListener("click", () => {
          // Close stepdown and return to emergency list
          toggleStepdown(false);
          toggleUrgent(true);
        });
        document.getElementById("stepdown-call").addEventListener("click", callEmergency);
        document.getElementById("stepdown-emergency").addEventListener("click", () => {
          toggleStepdown(false);
          toggleUrgent(true);
        });
        document.getElementById("stepdown-overlay").addEventListener("click", (e) => {
          if(e.target.id === "stepdown-overlay") toggleStepdown(false);
        });

        // speaker (footer for urgent, inline for crisis)
        document.getElementById("listen-btn").addEventListener("click", speakCurrent);
        document.getElementById("listen-inline").addEventListener("click", speakCurrent);

        // mic
        document.getElementById("mic-btn").addEventListener("click", toggleMic);

        // Info
        document.getElementById("info-open").addEventListener("click", () => toggleInfo(true));
        document.getElementById("info-close").addEventListener("click", () => toggleInfo(false));
        document.getElementById("info-overlay").addEventListener("click", (e) => {
          if(e.target.id === "info-overlay") toggleInfo(false);
        });

        // 999 / 111
        document.getElementById("call-emergency").addEventListener("click", callEmergency);
        document.getElementById("call-advice").addEventListener("click", callAdvice);

        // View all situations
        document.getElementById("view-all-btn").addEventListener("click", toggleViewAll);
        
        // Continue chip (home screen resume shortcut - handles both crisis and urgent)
        document.getElementById("continue-btn").addEventListener("click", () => {
          const chip = document.getElementById("continue-chip");
          const resumeType = chip.dataset.resumeType;
          
          if(resumeType === "urgent" && hasUrgentResumeAvailable()){
            openDeck(URGENT_DECKS, urgentResumeState.deckKey, urgentResumeState.stepIndex);
            clearUrgentResume();
          } else if(resumeType === "crisis" && hasCrisisResumeAvailable()){
            openDeck(CRISIS_DECKS, resumeState.deckKey, resumeState.stepIndex);
            clearResume();
          }
        });
        
        // Initialize continue chip visibility
        updateContinueChip();

        // Post-completion follow-up buttons
        document.getElementById("followup-calmer").addEventListener("click", () => showFollowupResponse("calmer"));
        document.getElementById("followup-same").addEventListener("click", () => showFollowupResponse("same"));
        document.getElementById("followup-worse").addEventListener("click", () => showFollowupResponse("worse"));
        document.getElementById("followup-close").addEventListener("click", () => closeFollowupAndExit());

        // Resume prompt: ESC and backdrop click dismiss (defaults to Start from Step 1)
        document.getElementById("resume-overlay").addEventListener("click", (e) => {
          if(e.target.id === "resume-overlay") dismissResumePrompt();
        });

        // global Escape closes the topmost overlay (one at a time)
        document.addEventListener("keydown", (e) => {
          if(e.key !== "Escape") return;
          if(isOpen("followup-response-overlay")){ closeFollowupAndExit(); return; }
          if(isOpen("followup-overlay")){ closeFollowupAndExit(); return; }
          if(isResumePromptOpen()){ dismissResumePrompt(); return; }
          if(isOpen("stepdown-overlay")){ toggleStepdown(false); return; }
          if(isOpen("urgent-overlay")){ toggleUrgent(false); return; }
          if(isOpen("info-overlay")){ toggleInfo(false); return; }
        });
        
        // Android back button: close overlay instead of navigating away
        window.addEventListener("popstate", (e) => {
          if(isOpen("followup-response-overlay")){ 
            closeFollowupAndExit();
            if(hasAnyOverlayOpen()) pushOverlayState();
            return; 
          }
          if(isOpen("followup-overlay")){ 
            closeFollowupAndExit();
            if(hasAnyOverlayOpen()) pushOverlayState();
            return; 
          }
          if(isResumePromptOpen()){ 
            dismissResumePrompt(); 
            pushOverlayState(); // Re-push if other overlays still open
            return; 
          }
          if(isOpen("stepdown-overlay")){ 
            toggleStepdown(false); 
            if(hasAnyOverlayOpen()) pushOverlayState();
            return; 
          }
          if(isOpen("urgent-overlay")){ 
            toggleUrgent(false); 
            if(hasAnyOverlayOpen()) pushOverlayState();
            return; 
          }
          if(isOpen("info-overlay")){ 
            toggleInfo(false); 
            if(hasAnyOverlayOpen()) pushOverlayState();
            return; 
          }
          // No overlay open: allow normal back navigation
          clearOverlayState();
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Detect region first so emergency number is set before any rendering
        detectRegion();
        
        // DEV-TIME: Check for hardcoded emergency numbers
        lintHardcodedEmergencyNumbers();
        
        renderHome();
        renderUrgentSheet();
        setupEmergencyPanel();
        initSpeechRecognition();

        // voices often load async
        if("speechSynthesis" in window){
          pickVoice();
          window.speechSynthesis.onvoiceschanged = pickVoice;
        }

        wire();
      });
    </script>
  
</body></html>