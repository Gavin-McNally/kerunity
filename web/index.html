<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Kerunity</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">

    <style>
      :root{
        --bg:#1a1a1a;
        --surface:#262626;
        --surface-hover:#2e2e2e;
        --text:#e8e6e3;
        --text-muted:#a0a0a0;
        --warm:#c4a882;
        --emergency:#c17a6a;
        --radius:12px;
}
      *{ box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
      body{
        margin:0;
        height:100vh;
        background:var(--bg);
        font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif;
        display:flex;
        justify-content:center;
        align-items:center;
        overflow:hidden;
        color:var(--text);
        font-size:18px;
        line-height:1.5;
      }

      #app-frame{
        width:100%;
        max-width:390px;
        height:100%;
        max-height:852px;
        background:var(--bg);
        display:flex;
        flex-direction:column;
        overflow:hidden;
        position:relative;
      }
      #app-content{ height:100%; display:flex; flex-direction:column; }

      /* Header */
      header{
        padding:20px 24px 16px;
        padding-top:calc(env(safe-area-inset-top) + 16px);
        flex-shrink:0;
      }
      .header-row{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:16px;
        gap:12px;
      }
      .brand{
        font-weight:500;
        font-size:19px;
        color:var(--text);
      }
      .header-actions{
        display:flex;
        align-items:center;
        gap:8px;
      }
      .header-actions .pill{ height:48px; min-width:48px; padding:0 14px; }

      /* Buttons */
      .pill{
        height:48px;
        min-width:48px;
        padding:0 16px;
        border-radius:var(--radius);
        border:none;
        background:var(--surface);
        color:var(--text);
        font-size:16px;
        font-weight:400;
        cursor:pointer;
        display:inline-flex;
        align-items:center;
        justify-content:center;
        gap:8px;
        user-select:none;
      }
      .pill:active{ opacity:0.7; }
      .pill[disabled]{ cursor:default; opacity:0.4; }
      .pill.active{ background:var(--surface-hover); }

      .emergency-call-btn{
        background:var(--emergency);
        color:#fff;
        font-weight:500;
      }
      .emergency-call-btn:active{ opacity:0.8; }

      .emergency-btn{
        color:var(--emergency);
        font-weight:500;
      }


      .icon-btn{ width:44px; padding:0; justify-content:center; }

      .subtitle{
        font-size:17px;
        color:var(--text);
        font-weight:400;
        line-height:1.6;
        margin:0 0 24px;
      }

      /* Canvas */
      .canvas{
        flex:1;
        overflow-y:auto;
        padding:0 24px;
        padding-bottom:calc(env(safe-area-inset-bottom) + 24px);
        scrollbar-width:none;
        -ms-overflow-style:none;
      }
      .canvas::-webkit-scrollbar{ width:0; height:0; }

      .search-box{ margin:0 0 32px; position:relative; }
      .search-input{
        width:100%;
        height:60px;
        background:var(--surface);
        border:1px solid #333;
        border-radius:var(--radius);
        padding:0 56px 0 18px;
        color:var(--text);
        font-size:18px;
        font-weight:400;
        outline:none;
      }
      .search-input:focus{ border-color:#555; }
      .search-input::placeholder{ color:var(--text-muted); }

      .mic-btn{
        position:absolute;
        right:6px;
        top:6px;
        width:48px;
        height:48px;
        display:flex;
        align-items:center;
        justify-content:center;
        background:transparent;
        border:none;
        color:var(--text-muted);
        cursor:pointer;
        border-radius:var(--radius);
      }
      .mic-btn:active{ background:rgba(255,255,255,0.05); }
      .mic-btn.listening{ color:var(--text); background:rgba(255,255,255,0.08); }


      /* Sections */
      .section-label{
        display:block;
        color:var(--text-muted);
        font-size:14px;
        font-weight:400;
        margin:0 0 14px;
      }
      .dot-green{ display:none; }

      .room-container{
        display:flex;
        flex-direction:column;
        gap:12px;
        margin-bottom:16px;
      }
      .room-container::before{ display:none; }

      .card{
        background:var(--surface);
        border-radius:var(--radius);
        padding:18px;
        cursor:pointer;
      }
      .card:focus{ outline:2px solid var(--warm); outline-offset:2px; }
      .card:active{ background:var(--surface-hover); }

      .glyph{ display:none; }
      .card-title{ font-size:19px; font-weight:500; line-height:1.35; color:var(--text); margin-bottom:4px; }
      .card-sub{ font-size:15px; font-weight:400; color:var(--text-muted); line-height:1.4; }

      .view-all-btn{
        width:100%;
        padding:16px;
        margin-top:12px;
        background:transparent;
        border:none;
        border-radius:var(--radius);
        color:var(--text-muted);
        font-size:16px;
        font-weight:400;
        cursor:pointer;
        min-height:56px;
      }
      .view-all-btn:active{ opacity:0.7; }

      /* Bottom Sheet (Info only) */
      .sheet-backdrop{
        position:absolute;
        inset:0;
        background:rgba(0,0,0,0.7);
        z-index:100;
        opacity:0;
        pointer-events:none;
      }
      .sheet-backdrop.active{ opacity:1; pointer-events:auto; }
      .sheet{
        position:absolute;
        bottom:0; left:0; right:0;
        background:var(--bg);
        border-radius:16px 16px 0 0;
        padding:24px;
        padding-bottom:calc(env(safe-area-inset-bottom) + 24px);
        transform:translateY(100%);
      }
      .sheet-backdrop.active .sheet{ transform:translateY(0); }

      /* Emergency: Full screen takeover, solid background */
      .emergency-backdrop{
        position:absolute;
        inset:0;
        z-index:120;
        background:var(--bg);
        opacity:0;
        pointer-events:none;
      }
      .emergency-backdrop.active{
        opacity:1;
        pointer-events:auto;
      }
      .emergency-screen{
        position:absolute;
        inset:0;
        background:var(--bg);
        display:flex;
        flex-direction:column;
        padding:24px;
        padding-top:calc(env(safe-area-inset-top) + 16px);
        padding-bottom:calc(env(safe-area-inset-bottom) + 24px);
      }

      .sheet-title{
        color:var(--text);
        font-size:19px;
        font-weight:500;
        margin-bottom:20px;
      }

      .urgent-row{
        width:100%;
        display:flex;
        align-items:center;
        gap:14px;
        padding:18px;
        background:var(--surface);
        border-radius:var(--radius);
        margin-bottom:12px;
        text-align:left;
        color:var(--text);
        cursor:pointer;
      }
      .urgent-row:focus{ outline:2px solid var(--warm); outline-offset:2px; }
      .urgent-row:active{ background:var(--surface-hover); }
      .u-icon{ display:none; }

      /* Crisis Card Full Screen */
      .stepdown-backdrop{
        position:absolute;
        inset:0;
        z-index:130;
        background:var(--bg);
        opacity:0;
        pointer-events:none;
      }
      .stepdown-backdrop.active{
        opacity:1;
        pointer-events:auto;
      }
      .stepdown-screen{
        position:absolute;
        inset:0;
        background:var(--bg);
        display:flex;
        flex-direction:column;
        padding:24px;
        padding-top:calc(env(safe-area-inset-top) + 16px);
        padding-bottom:calc(env(safe-area-inset-bottom) + 24px);
      }
      .stepdown-backdrop.active .stepdown-screen{
        opacity:1;
      }

      .stepdown-body{
        flex:1;
        overflow:auto;
        padding:24px 0;
        scrollbar-width:none;
        -ms-overflow-style:none;
        display:flex;
        flex-direction:column;
        justify-content:center;
      }
      .stepdown-body::-webkit-scrollbar{ width:0; height:0; }

      .crisis-card{
        width:100%;
        padding:0 24px;
        display:flex;
        flex-direction:column;
        justify-content:center;
      }

      .kicker{
        font-size:16px;
        font-weight:500;
        color:var(--warm);
        letter-spacing:0.02em;
        margin-bottom:10px;
      }
      .say-text{
        font-size:28px;
        font-weight:500;
        line-height:1.35;
        color:var(--text);
      }
      .divider{
        height:1px;
        background:#333;
        margin:24px 0;
      }
      .do-text{
        font-size:18px;
        font-weight:400;
        color:var(--text-muted);
        line-height:1.5;
      }
      /* DO-only steps: instruction text is largest in app */
      .do-text.do-only{
        font-size:32px;
        font-weight:500;
        color:var(--text);
        line-height:1.3;
      }

      .stepdown-footer{
        padding-top:16px;
      }

      .muted-link{
        background:none;
        border:none;
        width:100%;
        margin-top:16px;
        padding:12px 0;
        text-decoration:underline;
        font-size:14px;
        color:var(--text-muted);
        font-weight:400;
        cursor:pointer;
        min-height:44px;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .muted-link:active{ opacity:0.7; }

      .listen-btn{
        display:inline-flex;
        align-items:center;
        gap:8px;
        height:48px;
        padding:0 16px;
        border-radius:var(--radius);
        border:none;
        background:var(--surface);
        color:var(--text);
        font-size:16px;
        font-weight:400;
        cursor:pointer;
        white-space:nowrap;
      }
      .listen-btn:active{ opacity:0.7; }
      .listen-btn.speaking{ background:#333; }

      /* Reduced motion */
      @media (prefers-reduced-motion: reduce){
        *{ transition:none !important; animation:none !important; }
      }
    </style>
  </head>

  <body>
    <div id="app-frame">
      <div id="app-content">
        <header>
          <div class="header-row">
            <div class="brand">Kerunity</div>

            <div class="header-actions">
              <button class="pill icon-btn" id="info-open" type="button" aria-label="Info">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                  <circle cx="12" cy="12" r="10"></circle>
                  <path d="M12 16v-4"></path>
                  <path d="M12 8h.01"></path>
                </svg>
              </button>
              <button class="pill emergency-btn" type="button" id="urgent-open">Emergency</button>
            </div>
          </div>

          <div class="subtitle">
            Start here. You don't have to get this right.
          </div>
        </header>

        <div class="canvas">
          <div class="search-box">
            <input id="query" type="text" class="search-input" placeholder="Search situations">
            <button id="mic-btn" class="mic-btn" type="button" aria-label="Speak">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"></path>
                <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                <line x1="12" x2="12" y1="19" y2="22"></line>
              </svg>
            </button>
          </div>

          <div id="search-suggestions" class="room-container" style="display:none;"></div>

          <div id="common-home-section">
            <div class="section-label">Common situations</div>
            <div id="grid-container" class="room-container"></div>
            <button id="view-all-btn" type="button" class="view-all-btn" style="display:none;">
              View all situations
            </button>
          </div>
        </div>

        <!-- Crisis Card Screen -->
        <div id="stepdown-overlay" class="stepdown-backdrop" aria-hidden="true">
          <div class="stepdown-screen" role="dialog" aria-modal="true" aria-label="Crisis Card">
            <!-- Header: Title left, Close right. Never wrap. -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;">
              <div style="flex:1;min-width:0;">
                <div id="stepdown-title" style="font-size:18px;font-weight:500;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">Situation</div>
                <div id="stepdown-progress" style="font-size:16px;color:var(--text-muted);margin-top:4px;">Step 1 of 4</div>
              </div>
              <button id="stepdown-close" class="pill" type="button" aria-label="Close" style="flex-shrink:0;">Close</button>
            </div>

            <div class="stepdown-body">
              <div class="crisis-card">
                <div id="stepdown-say-section">
                  <div id="stepdown-say-kicker" class="kicker">Try saying this</div>
                  <div id="stepdown-say" class="say-text"></div>
                  <div class="divider"></div>
                </div>
                <div id="stepdown-do-kicker" class="kicker">You can do this</div>
                <div id="stepdown-do" class="do-text"></div>
                </div>
              </div>

            <div class="stepdown-footer">
              <!-- Emergency: persistent in content, not header -->
              <button id="stepdown-emergency" class="pill emergency-btn" type="button" style="width:100%;height:48px;margin-bottom:12px;">Emergency</button>
              
              <button id="stepdown-call" class="pill emergency-call-btn" type="button" style="display:none;width:100%;height:56px;font-size:18px;margin-bottom:12px;">
                <span id="stepdown-call-label">Call 999</span>
              </button>
              
              <!-- Listen button moved to footer -->
              <button id="listen-btn" class="listen-btn" type="button" aria-label="Listen" style="width:100%;margin-bottom:16px;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M11 5 6 9H2v6h4l5 4V5Z"></path>
                    <path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                  </svg>
                  <span class="listen-label">Listen</span>
                </button>

              <div style="display:flex;gap:12px;">
                <button id="stepdown-back" class="pill" type="button" style="flex:1;">Back</button>
                <button id="stepdown-next" class="pill" type="button" style="flex:1;">Next</button>
              </div>
              <button id="stepdown-done" class="muted-link" type="button">Done</button>
            </div>
              </div>
            </div>

        <!-- Emergency: Full screen takeover -->
        <div id="urgent-overlay" class="emergency-backdrop" aria-hidden="true">
          <div class="emergency-screen" role="dialog" aria-modal="true" aria-label="Emergency Help">
            <!-- Header: title left, close right -->
            <div style="display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:24px;">
              <div style="font-size:18px;font-weight:500;color:var(--text);">Emergency</div>
              <button id="urgent-close" class="pill" type="button" aria-label="Close" style="flex-shrink:0;">Close</button>
            </div>

            <div style="flex:1;overflow-y:auto;">
              <div id="emergency-hint" style="font-size:17px;color:var(--text);margin-bottom:24px;line-height:1.5;">
                If someone is in immediate danger, call now.
        </div>

              <div id="call-buttons" style="display:flex;gap:12px;margin-bottom:32px;">
                <button id="call-emergency" type="button" class="pill emergency-call-btn" style="flex:1;height:80px;flex-direction:column;gap:6px;">
                  <span id="emergency-number" style="font-size:24px;font-weight:500;">Call 999</span>
                  <span style="font-size:14px;opacity:0.7;">Emergency</span>
              </button>
                <button id="call-advice" type="button" class="pill" style="flex:1;height:80px;flex-direction:column;gap:6px;">
                  <span id="advice-number" style="font-size:24px;font-weight:500;">Call 111</span>
                  <span style="font-size:14px;color:var(--text-muted);">Medical advice</span>
              </button>
            </div>

              <div style="font-size:14px;color:var(--text-muted);margin-bottom:12px;">Safety checks</div>
            <div id="urgent-grid-sheet"></div>
            </div>
          </div>
        </div>

        <!-- Info sheet -->
        <div id="info-overlay" class="sheet-backdrop" aria-hidden="true">
          <div class="sheet" role="dialog" aria-modal="true" aria-label="Info">
            <div class="sheet-title">About this app</div>

            <div style="color:var(--text);line-height:1.6;margin-bottom:20px;">
              Kerunity offers calm, step-by-step guidance for carers.
            </div>

            <div style="color:var(--text-muted);line-height:1.7;font-size:15px;margin-bottom:24px;">
              <p id="info-emergency-line" style="margin:0 0 12px;">If you or they are in immediate danger, call 999 now.</p>
              <p style="margin:0 0 12px;">This is guidance, not medical advice.</p>
              <p style="margin:0 0 12px;">Keep everyone safe. Step away if you need to.</p>
              <p style="margin:0;">Tap Emergency for safety checks.</p>
            </div>

            <div style="border-top:1px solid #333;padding-top:20px;margin-bottom:16px;">
              <div style="font-size:14px;font-weight:500;color:var(--text);margin-bottom:12px;">Your privacy</div>
              <div style="color:var(--text-muted);line-height:1.7;font-size:14px;">
                <p style="margin:0 0 10px;">Your voice is never recorded.</p>
                <p style="margin:0 0 10px;">This app does not track you.</p>
                <p style="margin:0;">If you use this inside ChatGPT, OpenAI may save what you type.</p>
              </div>
            </div>

            <button id="info-close" class="muted-link" type="button">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      /* =========================
         DATA
      ========================== */
      /* Visible by default (Hick's Law: 6 is safe, 10 is limit) */
      const VISIBLE_COUNT = 6;

      const DATA = {
        /* Most common - shown first (6) - EXPANDED COVERAGE */
        refusing_meds: { 
          label: "Refusing meds", sub: "Won't take pills",
          keywords: ["medication", "pills", "tablets", "medicine", "drugs", "prescription", "dose", "swallow", "spit", "meds", "capsule", "liquid", "syrup", "pharmacy", "chemist", "GP", "doctor"],
          aliases: ["won't take medication", "refusing tablets", "spitting out pills", "hiding medication", "not taking medicine", "refuses to swallow", "won't swallow pills", "spits out tablets", "hiding pills in mouth", "says no to meds", "fighting medication", "won't open mouth for pills", "clamping mouth shut"]
        },
        wants_home: { 
          label: "Wants to go home", sub: "Confused about location",
          keywords: ["home", "leave", "go", "house", "back", "where", "lost", "place", "live", "bus", "taxi", "car", "door", "outside", "family", "parents", "childhood"],
          aliases: ["wants to leave", "going home", "take me home", "where do I live", "this isn't my house", "I want to go", "not my home", "need to get the bus", "waiting for a taxi", "when can I go home", "I don't live here", "where's my house", "wants to see parents", "going back to childhood home", "doesn't recognise house"]
        },
        asking_mom: { 
          label: "Asking for mom", sub: "Deceased relative",
          keywords: ["mom", "mum", "mother", "dad", "father", "parent", "dead", "deceased", "passed", "gone", "husband", "wife", "spouse", "nan", "grandma", "grandad", "brother", "sister"],
          aliases: ["where's my mum", "wants her mother", "asking for father", "when is mum coming", "I want my mum", "where's mom", "waiting for dad", "when's mum picking me up", "I need my mother", "where's my husband", "have you seen my wife", "asking for dead relative", "wants to see nan"]
        },
        stealing: { 
          label: "Accusing of stealing", sub: "Items 'missing'",
          keywords: ["stealing", "stole", "thief", "taken", "missing", "wallet", "money", "purse", "keys", "accuse", "blame", "robbed", "lost", "jewellery", "jewelry", "ring", "watch", "handbag", "bag"],
          aliases: ["says I stole", "accusing me", "thinks I took", "where's my money", "someone stole", "you took my", "things are missing", "keeps saying I stole it", "accusing carers of theft", "blaming me for stealing", "can't find wallet", "purse is missing", "who took my keys", "someone's been in my things", "money has gone"]
        },
        shadowing: { 
          label: "Shadowing", sub: "Following you constantly",
          keywords: ["following", "shadow", "clingy", "attached", "close", "behind", "everywhere", "stuck", "separation", "anxious", "needy", "dependent"],
          aliases: ["follows me everywhere", "won't let me out of sight", "always behind me", "can't leave them alone", "follows me around", "follows me to the toilet", "follows me to bathroom", "won't stay in room alone", "panics when I leave", "attached to my hip", "can't get any space", "follows room to room"]
        },
        hygiene: { 
          label: "Refusing hygiene", sub: "Won't wash/change",
          keywords: ["wash", "bath", "shower", "clean", "hygiene", "smell", "dirty", "change", "clothes", "teeth", "toilet", "bathroom", "loo", "nappy", "diaper", "pad", "incontinence", "wet", "soiled"],
          aliases: ["won't wash", "refusing bath", "won't shower", "hasn't changed clothes", "needs a wash", "refusing to clean", "won't brush teeth", "scared of shower", "afraid of bath", "won't change wet clothes", "sitting in wet pad", "smells bad", "hasn't bathed in days", "refuses personal care", "won't let me wash them"]
        },
        /* Extended - shown on "View all" (19 more = 25 total) - EXPANDED COVERAGE */
        sundowning: { 
          label: "Sundowning", sub: "Evening agitation",
          keywords: ["evening", "night", "sunset", "agitated", "restless", "worse", "afternoon", "dusk", "dark", "twilight", "late", "shadows", "anxious", "confused", "pacing", "upset"],
          aliases: ["gets worse at night", "evening agitation", "restless at sunset", "anxious in evening", "agitated after dark", "worse in late afternoon", "pacing at night", "confused when it gets dark", "sundown syndrome", "evening confusion", "worse as sun goes down", "unsettled at teatime", "bad every evening"]
        },
        wont_eat: { 
          label: "Won't eat", sub: "Refusing food/drink",
          keywords: ["eat", "food", "drink", "hungry", "meal", "appetite", "swallow", "chew", "water", "tea", "coffee", "breakfast", "lunch", "dinner", "snack", "thirsty", "dehydrated", "weight"],
          aliases: ["not eating", "refusing food", "won't drink", "no appetite", "stopped eating", "pushing food away", "spitting food out", "won't open mouth", "not drinking enough", "losing weight", "barely eating", "picks at food", "won't touch meals", "refusing tea", "dehydrated"]
        },
        repetitive: { 
          label: "Repeating questions", sub: "Asking same thing",
          keywords: ["repeat", "again", "same", "question", "asking", "over", "loop", "constant", "broken", "record", "endless", "nonstop", "obsessive", "stuck"],
          aliases: ["asking same thing", "keeps repeating", "same question", "over and over", "asks constantly", "broken record", "asked this already", "keeps asking same thing", "won't stop asking", "repetitive questions", "stuck in a loop", "asks every five minutes", "endless questions"]
        },
        aggression: { 
          label: "Aggression", sub: "Shouting / hitting / throwing things",
          keywords: ["aggressive", "hitting", "shouting", "angry", "violent", "punch", "kick", "yelling", "attack", "slap", "bite", "scratch", "push", "shove", "grab", "rage", "fury", "temper"],
          aliases: ["being aggressive", "hit me", "shouting at me", "getting violent", "lashing out", "tried to punch me", "kicked me", "grabbed my arm", "scratched me", "bit me", "pushed me away", "screaming at me", "flew into a rage", "lost their temper", "threatening behaviour"]
        },
        sleep: { 
          label: "Sleep problems", sub: "Up at night",
          keywords: ["sleep", "night", "awake", "insomnia", "tired", "bed", "rest", "waking", "wandering", "nocturnal", "disturbed", "exhausted", "morning", "routine", "nap", "daytime"],
          aliases: ["can't sleep", "up all night", "won't go to bed", "waking up", "not sleeping", "wandering at night", "awake at 3am", "thinks it's morning", "sleeping all day", "day night reversed", "exhausted but won't sleep", "gets up repeatedly", "disturbed sleep pattern", "night time wandering"]
        },
        lost: { 
          label: "Lost / confused", sub: "Doesn't recognise place",
          keywords: ["lost", "confused", "where", "recognise", "place", "room", "house", "disoriented"],
          aliases: ["doesn't know where", "seems lost", "very confused", "doesn't recognise"]
        },
        wandering: { 
          label: "Wandering", sub: "Trying to leave",
          keywords: ["wander", "walk", "leave", "door", "outside", "escape", "exit", "roam", "pacing", "restless", "garden", "street", "lost", "front", "back", "gate", "key", "lock"],
          aliases: ["trying to leave", "at the door", "wants to go outside", "keeps wandering", "walking around", "trying to get out", "pacing up and down", "found at front door", "went out the back", "escaped from house", "wandered off", "walking the streets", "let themselves out", "keeps trying door handle", "looking for way out"]
        },
        hiding: { 
          label: "Hiding things", sub: "Can't find items",
          keywords: ["hiding", "hidden", "lost", "find", "where", "put", "missing", "moved"],
          aliases: ["hides things", "can't find", "where did I put", "things go missing", "hidden items"]
        },
        undressing: { 
          label: "Undressing", sub: "Removing clothes",
          keywords: ["undress", "naked", "clothes", "strip", "remove", "taking off"],
          aliases: ["taking clothes off", "getting undressed", "removing clothes", "keeps undressing"]
        },
        rummaging: { 
          label: "Rummaging", sub: "Going through drawers",
          keywords: ["rummage", "drawer", "cupboard", "search", "through", "looking", "mess"],
          aliases: ["going through drawers", "searching cupboards", "making a mess", "rummaging around"]
        },
        hoarding: { 
          label: "Hoarding", sub: "Collecting / keeping things",
          keywords: ["hoard", "collect", "keep", "save", "pile", "stuff", "junk", "rubbish"],
          aliases: ["collecting things", "won't throw away", "keeping everything", "piling up stuff"]
        },
        crying: { 
          label: "Crying / tearful", sub: "Upset for no clear reason",
          keywords: ["crying", "tears", "upset", "sad", "weeping", "emotional", "distressed"],
          aliases: ["keeps crying", "very upset", "tearful", "crying for no reason", "emotionally distressed"]
        },
        wont_get_up: { 
          label: "Won't get up", sub: "Staying in bed",
          keywords: ["bed", "up", "get", "lying", "stay", "morning", "wake"],
          aliases: ["won't get out of bed", "staying in bed", "refuses to get up", "won't wake up"]
        },
        refusing_help: { 
          label: "Refusing help", sub: "Won't accept care",
          keywords: ["help", "refuse", "care", "assist", "support", "independent", "stubborn"],
          aliases: ["won't accept help", "refuses care", "pushes me away", "doesn't want help"]
        },
        paranoid: { 
          label: "Paranoid", sub: "Suspicious of others",
          keywords: ["paranoid", "suspicious", "trust", "people", "watching", "spy", "conspiracy", "poison", "plotting", "neighbour", "neighbor", "carer", "staff", "delusion", "persecuted", "threatened"],
          aliases: ["very suspicious", "doesn't trust", "thinks people are watching", "paranoid thoughts", "thinks I'm poisoning food", "says neighbours are spying", "accuses staff of plotting", "doesn't trust anyone", "thinks people want to hurt them", "suspicious of carers", "feels persecuted", "convinced someone is after them", "paranoid about visitors"]
        },
        hallucinations: { 
          label: "Seeing things", sub: "Things that aren't there",
          keywords: ["seeing", "hallucination", "vision", "people", "things", "imaginary", "hear", "voices", "children", "intruders", "strangers", "animals", "bugs", "insects", "dead", "deceased", "ghost", "shadow"],
          aliases: ["seeing things", "hearing voices", "people that aren't there", "hallucinating", "sees children in the room", "talking to dead relatives", "sees intruders", "thinks there are strangers here", "seeing animals", "bugs on the wall", "sees shadows moving", "talking to people who aren't there", "says someone is in the house", "visual hallucinations"]
        },
        inappropriate: { 
          label: "Inappropriate comments", sub: "Saying awkward things",
          keywords: ["inappropriate", "rude", "sexual", "comments", "embarrassing", "awkward", "offensive"],
          aliases: ["saying inappropriate things", "rude comments", "embarrassing behaviour", "sexual comments"]
        },
        wont_dress: { 
          label: "Won't get dressed", sub: "Refusing clothes",
          keywords: ["dress", "clothes", "wear", "outfit", "change", "morning", "pyjamas"],
          aliases: ["won't get dressed", "refusing to dress", "staying in pyjamas", "won't change clothes"]
        },
        forgot_face: { 
          label: "Doesn't know me", sub: "Forgotten who you are",
          keywords: ["know", "recognise", "who", "face", "forget", "stranger", "remember"],
          aliases: ["doesn't recognise me", "forgot who I am", "thinks I'm a stranger", "doesn't know who I am"]
        },
        /* FALLBACK - never shown in list */
        fallback_not_sure: {
          label: "Not sure what this is", sub: "Start here. One step at a time.",
          isFallback: true,
          keywords: [],
          aliases: []
        }
      };

      const CRISIS_DECKS = {
        refusing_meds:{ title:"Refusing meds", steps:[
          { say:"It's okay. We don't have to do this right now.", do:"Take the pressure off. Relax your shoulders. Speak slowly." },
          { say:"Can we take a sip of water first, then decide?", do:"Offer one tiny first step. Give two choices: water or tea." },
          { say:"Would you like to take it with me, or would you prefer later?", do:"Give two acceptable options. Avoid saying 'you must'." },
          { say:"Thank you. That's enough for now. We'll check again later.", do:"Say \"That's okay. We'll try later.\" Then stop asking for now. Try again in 10-20 minutes. If you're worried, call for medical advice." }
        ]},
        wants_home:{ title:"Wants to go home", steps:[
          { say:"I hear you. You want to go home. Tell me about home.", do:"Validate and invite description. Don't correct location facts." },
          { say:"Let's get you comfortable first, then we'll make a plan.", do:"Move to comfort: chair, drink, loo, warmer/blanket." },
          { say:"Shall we have a cup of tea first, then we'll decide?", do:"Use a short delay + familiar ritual. Keep it calm and simple." },
          { say:"You're safe with me. We'll sort it together.", do:"Close with safety + togetherness. Reduce stimulation." }
        ]},
        asking_mom:{ title:"Asking for mom", steps:[
          { say:"You miss her. Tell me about her.", do:"Join the emotion. Don't correct facts." },
          { say:"What would she want you to do right now?", do:"Redirect toward a safe action (sit, tea, photo, music)." },
          { say:"Let’s do something that would make her proud.", do:"Small task: fold towel, water plant, look at album." },
          { say:"I’m here with you. You’re not on your own.", do:"Close with reassurance and presence." }
        ]},
        stealing:{ title:"Accusing of stealing", steps:[
          { say:"That sounds really worrying. Let’s look together.", do:"Validate. Avoid defending yourself or debating." },
          { say:"Where did you last remember seeing it?", do:"Turn into a ‘search mission’ with gentle questions." },
          { say:"Let’s check the usual safe places first.", do:"Go to 2–3 common spots only. Keep pace slow." },
          { say:"If it’s not here, we’ll leave it and try again later.", do:"Close without ‘you’re wrong’. Offer a calming reset." }
        ]},
        shadowing:{ title:"Shadowing", steps:[
          { say:"You're okay. I'm here. Let's do this together.", do:"Reassure first. Keep tone warm, not hurried." },
          { say:"Could you sit here? I have a job for you.", do:"Give a 'job': hold towel, watch kettle, fold cloth." },
          { say:"I'll be back in two minutes. Watch the timer for me.", do:"Use a timer + clear promise. Return when you say you will." },
          { say:"Thank you. You did great helping me.", do:"Praise the helper role. Repeat predictable routine." }
        ]},
        hygiene:{ title:"Refusing hygiene", steps:[
          { say:"No problem. We can do this gently.", do:"Remove pressure. Avoid 'you have to' language." },
          { say:"Would you like a warm cloth wash instead of a full wash?", do:"Offer a smaller option: face/hands first." },
          { say:"Do you want the bathroom warmer, or a towel warmed?", do:"Fix discomfort triggers: cold room, lighting, privacy." },
          { say:"That's enough for now. We'll stop there.", do:"Close early with success. Short wins beat battles." }
        ]},
        sundowning:{ title:"Sundowning", steps:[
          { say:"I can see you're feeling unsettled. I'm here.", do:"Acknowledge their distress. Don't dismiss or argue." },
          { say:"Let's turn on some lights and get cosy.", do:"Close curtains. Turn on more lights." },
          { say:"Would you like to sit with me for a bit?", do:"Gentle distraction: music, photo, simple activity." },
          { say:"You're safe. We'll get through the evening together.", do:"Stay calm. Predictable routine helps." }
        ]},
        wont_eat:{ title:"Won't eat", steps:[
          { say:"That's okay. No rush. We can try again later.", do:"Don't force. Remove pressure around mealtimes." },
          { say:"Would you like something small? Just a few bites?", do:"Offer finger foods, small portions, favourite tastes." },
          { say:"Let's sit together while I have mine.", do:"Eating together can encourage. Keep it social." },
          { say:"You did well. We'll have more later if you want.", do:"Praise any attempt. Make a quiet note for later." }
        ]},
        repetitive:{ title:"Repeating questions", steps:[
          { say:"That's a good question. Let me help.", do:"Answer as if it's the first time. Stay patient." },
          { say:"I'll write it down so we can check.", do:"Use a whiteboard or note to point to." },
          { say:"Let's do something together while we wait.", do:"Redirect to a simple activity or task." },
          { say:"I'm here. We're okay.", do:"Reassurance is what they need, not facts." }
        ]},
        aggression:{ title:"Aggression", steps:[
          { say:"I can see you're upset. I'm going to step back.", do:"Give space. Don't corner or crowd them." },
          { say:"You're safe. I'm here.", do:"Speak slowly. Sit down only if you can get up easily." },
          { say:"Let's take a breath together.", do:"Breathe slowly yourself. Wait for them to calm down." },
          { say:"Thank you. Let's sit down when you're ready.", do:"Don't hold grudges. Reset and move forward." }
        ]},
        sleep:{ title:"Sleep problems", steps:[
          { say:"Can't sleep? That's okay. Let's sit quietly.", do:"Don't argue about time. Join them calmly." },
          { say:"Would you like a warm drink or the radio on?", do:"Offer comfort. Dim lights. Keep voice soft." },
          { say:"We can rest here together for a bit.", do:"Don't force bed. Sitting nearby is fine." },
          { say:"You're safe. I'll be here if you need me.", do:"Reassure and let natural tiredness come." }
        ]},
        lost:{ title:"Lost / confused", steps:[
          { say:"You're safe with me.", do:"State location simply. Don't quiz or test them." },
          { say:"This is the kitchen.", do:"Point to familiar objects." },
          { say:"Let's go to your chair / your room.", do:"Guide to a familiar, comfortable spot." },
          { say:"You're home. I'm here with you.", do:"Reassurance matters more than facts." }
        ]},
        wandering:{ title:"Wandering", steps:[
          { say:"Where are we going? I'll walk with you.", do:"Don't block or grab. Walk alongside calmly." },
          { say:"Let's check together. What are you looking for?", do:"Make it a shared mission, not a confrontation." },
          { say:"It's cold/dark out there. Let's get a cup of tea first.", do:"Offer distraction before they reach the door." },
          { say:"You're safe here. Let's sit down for a moment.", do:"Guide gently back to a chair. Make sure doors are secure later." }
        ]},
        hiding:{ title:"Hiding things", steps:[
          { say:"I can see something's important to you.", do:"Don't accuse or demand. Stay calm and curious." },
          { say:"Can you show me where you put it?", do:"Let them lead. They may remember hiding spots." },
          { say:"Let's keep it safe together.", do:"Create a 'safe box' for important items." },
          { say:"Thank you for showing me.", do:"Don't make it a big deal. Note the hiding spots." }
        ]},
        undressing:{ title:"Undressing", steps:[
          { say:"Are you feeling too warm?", do:"Check temperature, clothing comfort, toileting needs." },
          { say:"Let's find something more comfortable.", do:"Offer loose, easy clothes they can manage." },
          { say:"Here. This will feel better.", do:"Redirect with a soft blanket or familiar item." },
          { say:"You're okay. Let's get comfy.", do:"Cover them gently. Move to a private room." }
        ]},
        rummaging:{ title:"Rummaging", steps:[
          { say:"What are you looking for? I can help.", do:"Join in rather than stopping them." },
          { say:"Let's check this drawer together.", do:"Redirect to a 'safe' drawer with harmless items." },
          { say:"I've put some things here for you to sort.", do:"Create a rummage box with safe objects." },
          { say:"Thank you for tidying.", do:"Make it purposeful. Praise their effort." }
        ]},
        hoarding:{ title:"Hoarding", steps:[
          { say:"That looks important. Tell me about it.", do:"Don't throw things away now." },
          { say:"Shall we find a special place for these?", do:"Offer a box or bag to 'keep things safe'." },
          { say:"Let's sort through together when you're ready.", do:"Remove items gradually, not all at once." },
          { say:"You've got some lovely things here.", do:"Validate their attachment. Be patient." }
        ]},
        crying:{ title:"Crying / tearful", steps:[
          { say:"I can see you're upset. I'm here.", do:"Sit close. Don't rush to fix or explain." },
          { say:"It's okay to feel this way.", do:"Validate the emotion even if cause is unclear." },
          { say:"Would you like a hug / hand to hold?", do:"Offer comfort. Physical touch if welcome." },
          { say:"I'm not going anywhere. Take your time.", do:"Be present. The feeling will pass." }
        ]},
        wont_get_up:{ title:"Won't get up", steps:[
          { say:"Good morning. No rush. Take your time.", do:"Don't force. Check if they're unwell or in pain." },
          { say:"Would you like a cup of tea in bed?", do:"Bring comfort to them first." },
          { say:"The bathroom's ready when you are.", do:"Give a gentle reason to move, not an order." },
          { say:"Let's just sit up for a bit.", do:"Small steps. Sitting up is progress." }
        ]},
        refusing_help:{ title:"Refusing help", steps:[
          { say:"That's okay. I'll be right over here.", do:"Step back. Don't argue or insist." },
          { say:"I'll be nearby if you change your mind.", do:"Give them space but stay available." },
          { say:"Can I help with just this one thing?", do:"Offer help with one tiny task only." },
          { say:"You're doing well. Let me know if you need me.", do:"Praise independence. Try again later." }
        ]},
        paranoid:{ title:"Paranoid", steps:[
          { say:"That sounds frightening. Tell me more.", do:"Listen without dismissing or arguing." },
          { say:"I can see why you're worried.", do:"Validate the feeling, not the belief." },
          { say:"Let's check together. I'll stay with you.", do:"Offer to investigate. Be their ally." },
          { say:"You're safe with me. I'm staying right here.", do:"Reassure. Reduce stimulation." }
        ]},
        hallucinations:{ title:"Seeing things", steps:[
          { say:"What can you see? Tell me about it.", do:"Stay calm. Don't argue or dismiss." },
          { say:"That must feel strange.", do:"Acknowledge their experience is real to them." },
          { say:"Let's turn on more lights / move rooms.", do:"Change environment. Reduce shadows." },
          { say:"I'm here with you. You're safe with me.", do:"Reassure. Don't pretend to see it too." }
        ]},
        inappropriate:{ title:"Inappropriate comments", steps:[
          { say:"Let's talk about something else.", do:"Redirect calmly. Don't shame or scold." },
          { say:"I know you don't mean to upset anyone.", do:"Assume good intent. They may not understand." },
          { say:"Come with me. I need your help.", do:"Move them away from the situation." },
          { say:"It's okay. Let's move on.", do:"Don't dwell. Apologise to others later if needed." }
        ]},
        wont_dress:{ title:"Won't get dressed", steps:[
          { say:"Let's take our time. No rush.", do:"Don't force. Check if clothes are uncomfortable." },
          { say:"Would you like to choose what to wear?", do:"Offer simple choices. Two options max." },
          { say:"Let's just put this on for now.", do:"One item at a time. Start with easiest piece." },
          { say:"You look nice. Well done.", do:"Praise any progress. Comfort over perfection." }
        ]},
        forgot_face:{ title:"Doesn't know me", steps:[
          { say:"Hello, I'm [name]. I'm here to help.", do:"Don't say 'Don't you remember me?' Stay calm." },
          { say:"We're friends. I've known you a long time.", do:"Reassure with warmth, not facts." },
          { say:"Let me show you some photos.", do:"Pictures may help. Don't quiz or test." },
          { say:"I care about you. That's what matters.", do:"Focus on feeling safe, not being recognised." }
        ]},
        fallback_not_sure:{ title:"Not sure what this is", steps:[
          { say:"Okay. We can slow down. I'm here with you.", do:"Speak quietly. Relax your shoulders." },
          { say:"What do you need right now?", do:"Ask one gentle question. Listen without rushing." },
          { say:"That's okay. We can sit quietly.", do:"If you feel unsafe or don't know what to do, tap Emergency." },
          { say:"We'll figure this out together.", do:"Stay with them. One moment at a time." }
        ]}
      };

      const URGENT_ITEMS = [
        { 
          key:"unresponsive", label:"Unresponsive", sub:"Won't wake up",
          keywords: ["unresponsive", "unconscious", "wake", "passed", "out", "fainted", "collapsed", "limp", "floppy", "not", "responding", "lifeless", "coma", "blackout", "knocked"],
          aliases: ["won't wake up", "passed out", "collapsed on floor", "not responding", "can't wake them", "fainted", "found unconscious", "not moving", "completely limp", "blacked out", "knocked out", "won't respond to voice", "eyes won't open"]
        },
        { 
          key:"breathing",    label:"Breathing trouble", sub:"Gasping / Choking",
          keywords: ["breathing", "breath", "choking", "choke", "gasp", "wheeze", "cough", "airway", "blue", "lips", "oxygen", "struggling", "suffocate", "throat", "swallow", "aspirate"],
          aliases: ["can't breathe", "struggling to breathe", "choking on food", "gasping for air", "gone blue", "lips are blue", "wheezing badly", "food stuck in throat", "trouble breathing", "short of breath", "breathing problems", "not breathing properly", "coughing and choking"]
        },
        { 
          key:"stroke",       label:"Stroke signs", sub:"Face, Arms, Speech",
          keywords: ["stroke", "face", "droop", "arm", "weak", "speech", "slur", "fast", "paralysis", "numbness", "side", "dizzy", "sudden", "confusion", "vision", "headache"],
          aliases: ["face drooping", "arm weakness", "slurred speech", "think it's a stroke", "can't lift arm", "face looks different", "one side weak", "sudden confusion", "FAST signs", "can't speak properly", "words not making sense", "stroke symptoms"]
        },
        { 
          key:"fall",         label:"Bad fall", sub:"Head injury / Pain",
          keywords: ["fall", "fell", "fallen", "head", "injury", "hurt", "pain", "hip", "fracture", "broken", "bleeding", "bump", "bruise", "floor", "stairs", "trip"],
          aliases: ["had a fall", "fell over", "hit their head", "fallen on floor", "can't get up after fall", "hurt after falling", "fell down stairs", "tripped and fell", "banged their head", "bleeding from fall", "possible fracture", "fell out of bed", "found on floor"]
        },
        { 
          key:"general_emergency", label:"Something feels seriously wrong", sub:"Need immediate help",
          keywords: ["emergency", "urgent", "ambulance", "danger", "unsafe", "serious", "help", "critical", "dying", "999", "112", "911"],
          aliases: ["need ambulance", "call ambulance", "this is an emergency", "urgent help now", "immediate danger", "something is seriously wrong", "can't cope", "can't handle this", "need help now", "feels very wrong", "i think they're dying"]
        }
      ];

      const URGENT_DECKS = {
        unresponsive:{ title:"Unresponsive", steps:[
          { say:null, do:"Call {EMERGENCY} now. Put phone on speaker. Follow operator instructions." },
          { say:null, do:"Check breathing. If not breathing normally, start CPR. If you're unsure, the {EMERGENCY} operator will tell you what to do." },
          { say:null, do:"If breathing, place in recovery position. Keep warm. Stay with them until help arrives." }
        ]},
        breathing:{ title:"Breathing trouble", steps:[
          { say:null, do:"If they can't speak or breathe, call {EMERGENCY} now. If you're worried at all, call {EMERGENCY} now. If they're coughing, let them cough." },
          { say:"I'm here with you. You're not alone.", do:"Help them sit upright. Loosen tight clothing. Open a window." },
          { say:null, do:"If they're still struggling to breathe, call {EMERGENCY} now. If you're unsure what to do, call for medical advice." }
        ]},
        stroke:{ title:"Stroke signs", steps:[
          { say:null, do:"Call {EMERGENCY} immediately. Note the time symptoms started." },
          { say:null, do:"Check FAST: Face drooping? Arm weak? Speech slurred? Call {EMERGENCY} now." },
          { say:"I'm here. Help is coming. Stay still.", do:"Do not give food or drink. Stay with them until help arrives." }
        ]},
        fall:{ title:"Bad fall", steps:[
          { say:"Don't try to move. I'm going to help you.", do:"If they hit their head, are bleeding, can't move, or you're worried at all, call {EMERGENCY} now." },
          { say:"Take your time. There's no rush.", do:"Check for pain, bleeding, alertness. Keep them warm and still." },
          { say:null, do:"If you're unsure what to do, call for medical advice. If they get worse at any point, call {EMERGENCY}." }
        ]},
        general_emergency:{ title:"Something feels seriously wrong", steps:[
          { say:null, do:"Trust your instincts. If something feels seriously wrong, call {EMERGENCY} now." },
          { say:"I'm here with you. Help is on the way.", do:"Keep them warm and still. Talk calmly. Note any symptoms." },
          { say:null, do:"You're doing the right thing. It's always OK to call for help." }
        ]}
      };

      /* =========================
         RENDER
      ========================== */
      let showAllSituations = false;

      // Get situation keys excluding fallback
      function getSituationKeys(){
        return Object.keys(DATA).filter(k => !DATA[k].isFallback);
      }

      function renderHome(){
        const grid = document.getElementById("grid-container");
        const viewAllBtn = document.getElementById("view-all-btn");
        const keys = getSituationKeys();
        const total = keys.length;
        const visibleKeys = showAllSituations ? keys : keys.slice(0, VISIBLE_COUNT);

        grid.innerHTML = visibleKeys.map(k => {
          const item = DATA[k];
          return `
            <div class="card" role="button" tabindex="0" data-key="${k}">
                <div class="card-title">${item.label}</div>
                <div class="card-sub">${item.sub}</div>
              </div>
          `;
        }).join("");

        // Show/hide "View all" button
        if(total > VISIBLE_COUNT){
          viewAllBtn.style.display = "block";
          if(showAllSituations){
            viewAllBtn.textContent = "Show fewer";
          } else {
            viewAllBtn.textContent = `View all ${total} situations`;
          }
        } else {
          viewAllBtn.style.display = "none";
        }
      }

      function toggleViewAll(){
        showAllSituations = !showAllSituations;
        renderHome();
      }

      /* =========================
         SEARCH / TYPEAHEAD
      ========================== */
      const SEARCH_THRESHOLD = 4;

      /* HARD EMERGENCY TOKENS - if any match, route to Emergency immediately */
      const EMERGENCY_TOKENS = {
        // Category 1: Breathing & consciousness
        breathing: ["not breathing", "cant breathe", "can't breathe", "breathing trouble", "gasping", "unconscious", "collapsed", "passed out", "unresponsive", "choking", "blue lips", "not responding", "wont wake", "won't wake", "fainted", "lifeless"],
        // Category 2: Stroke & heart
        stroke: ["stroke", "face drooping", "slurred speech", "heart attack", "chest pain", "arm pain", "sudden weakness", "sudden confusion", "fast test", "face droop", "one side weak"],
        // Category 3: Falls & injury
        injury: ["bad fall", "hit head", "head injury", "bleeding", "cant get up", "can't get up", "broken", "severe pain", "fracture", "found on floor"],
        // Category 4: Immediate danger
        danger: ["fire", "danger", "unsafe", "violent now", "aggressive now", "weapon", "threatening", "emergency", "ambulance", "999", "112", "dying", "immediate danger", "seriously wrong"]
      };

      function normalizeQuery(str){
        return str.toLowerCase().trim().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ');
      }

      /* Escape regex special characters */
      function escapeRegex(str){
        return str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
      }

      /* Check if query contains emergency intent - returns true if ANY hard token matches */
      function hasEmergencyIntent(query){
        const q = normalizeQuery(query);
        if(!q) return false;
        
        for(const category of Object.values(EMERGENCY_TOKENS)){
          for(const token of category){
            // Multi-word phrases: use includes (safe, requires full phrase)
            // Single-word tokens: use word-boundary regex to prevent "fire" matching "fireplace"
            if(token.includes(' ')){
              if(q.includes(token)) return true;
            } else {
              const escaped = escapeRegex(token);
              const regex = new RegExp('\\b' + escaped + '\\b', 'i');
              if(regex.test(q)) return true;
            }
          }
        }
        return false;
      }

      /* Find which specific emergency items match the query */
      function matchEmergencyItems(query){
        const q = normalizeQuery(query);
        const matches = [];
        
        for(const item of URGENT_ITEMS){
          let score = 0;
          const label = normalizeQuery(item.label);
          const sub = normalizeQuery(item.sub);
          
          if(label.includes(q)) score += 6;
          if(sub.includes(q)) score += 4;
          
          if(item.aliases){
            for(const alias of item.aliases){
              if(normalizeQuery(alias).includes(q)){ score += 5; break; }
            }
          }
          if(item.keywords){
            for(const kw of item.keywords){
              const nkw = normalizeQuery(kw);
              if(nkw === q){ score += 3; break; }
              else if(nkw.includes(q) || q.includes(nkw)){ score += 2; }
            }
          }
          
          if(score > 0) matches.push({ key: item.key, score, isUrgent: true });
        }
        
        // Sort by score, return all matches (or general_emergency as fallback)
        matches.sort((a, b) => b.score - a.score);
        if(matches.length === 0){
          // Emergency intent detected but no specific match → general emergency
          return [{ key: 'general_emergency', score: 10, isUrgent: true }];
        }
        return matches;
      }

      function scoreItem(item, query){
        if(item.isFallback) return 0;
        
        let score = 0;
        const q = normalizeQuery(query);
        if(!q) return 0;
        
        const label = normalizeQuery(item.label);
        const sub = normalizeQuery(item.sub);
        
        if(label.includes(q)) score += 6;
        if(sub.includes(q)) score += 4;
        
        if(item.aliases){
          for(const alias of item.aliases){
            if(normalizeQuery(alias).includes(q)){ score += 5; break; }
          }
        }
        if(item.keywords){
          for(const kw of item.keywords){
            const nkw = normalizeQuery(kw);
            if(nkw === q){ score += 3; break; }
            else if(nkw.includes(q) || q.includes(nkw)){ score += 2; }
          }
        }
        
        return score;
      }

      const URGENT_THRESHOLD = 5; // Higher threshold for urgent to avoid false positives

      function searchSituations(query){
        const q = normalizeQuery(query);
        if(!q) return [];
        
        /* PRIORITY 1: Emergency intent check - if detected, return ONLY urgent items */
        if(hasEmergencyIntent(query)){
          return matchEmergencyItems(query);
        }
        
        /* PRIORITY 2: Score urgent items - only return if they genuinely match well */
        const urgentScored = URGENT_ITEMS.map(item => ({ key: item.key, score: scoreItem(item, query), isUrgent: true }))
                                         .filter(x => x.score > 0); // Filter out non-matches first
        urgentScored.sort((a, b) => b.score - a.score);
        
        // Only return urgent items if top score meets higher threshold
        if(urgentScored.length > 0 && urgentScored[0].score >= URGENT_THRESHOLD){
          return urgentScored;
        }
        
        /* PRIORITY 3: Normal crisis matching */
        const keys = getSituationKeys();
        const regularScored = keys.map(k => ({ key: k, score: scoreItem(DATA[k], query), isUrgent: false }))
                                  .filter(x => x.score > 0)
                                  .sort((a, b) => b.score - a.score);
        
        if(regularScored.length > 0 && regularScored[0].score >= SEARCH_THRESHOLD){
          return regularScored.slice(0, 5);
        }
        
        /* PRIORITY 4: Fallback */
        return [{ key: 'fallback_not_sure', score: 0, isUrgent: false }];
      }

      function renderSuggestions(results){
        const container = document.getElementById("search-suggestions");
        const homeSection = document.getElementById("common-home-section");
        
        if(results.length === 0){
          container.style.display = "none";
          homeSection.style.display = "block";
          return;
        }
        
        container.style.display = "flex";
        homeSection.style.display = "none";
        
        container.innerHTML = results.map(r => {
          // Get item data from appropriate source
          let item;
          if(r.isUrgent){
            item = URGENT_ITEMS.find(u => u.key === r.key);
          } else {
            item = DATA[r.key];
          }
          if(!item) return '';
          
          return `
            <div class="card${r.isUrgent ? ' urgent-suggestion' : ''}" role="button" tabindex="0" data-key="${r.key}" data-urgent="${r.isUrgent}">
                <div class="card-title">${item.label}</div>
                <div class="card-sub">${item.sub}</div>
            </div>
          `;
        }).join("");
      }

      function handleSearchInput(e){
        const query = e.target.value;
        if(query.trim().length === 0){
          renderSuggestions([]);
        } else {
          const results = searchSituations(query);
          renderSuggestions(results);
        }
      }

      function renderUrgentSheet(){
        const list = document.getElementById("urgent-grid-sheet");
        list.innerHTML = URGENT_ITEMS.map(it => `
          <div class="urgent-row" role="button" tabindex="0" data-urgent="${it.key}">
            <div>
              <div style="font-weight:500;font-size:19px;line-height:1.35;margin-bottom:4px;">${it.label}</div>
              <div style="font-size:15px;color:var(--text-muted);line-height:1.4;">${it.sub}</div>
            </div>
          </div>
        `).join("");
      }

      /* =========================
         OVERLAYS
      ========================== */
      function isOpen(id){
        const el = document.getElementById(id);
        return !!el && el.classList.contains("active");
      }

      function setBodyLock(lock){
        document.body.style.overflow = lock ? "hidden" : "";
      }

      function toggleUrgent(show){
        const el = document.getElementById("urgent-overlay");
        if(!el) return;
        if(!show) document.getElementById("urgent-open")?.focus();
        el.classList.toggle("active", !!show);
        el.setAttribute("aria-hidden", show ? "false" : "true");
        setBodyLock(show || isOpen("stepdown-overlay") || isOpen("info-overlay"));
        if(show) document.getElementById("urgent-close")?.focus();
      }

      function toggleInfo(show){
        const el = document.getElementById("info-overlay");
        if(!el) return;
        if(!show) document.getElementById("info-open")?.focus();
        el.classList.toggle("active", !!show);
        el.setAttribute("aria-hidden", show ? "false" : "true");
        setBodyLock(show || isOpen("stepdown-overlay") || isOpen("urgent-overlay"));
        if(show) document.getElementById("info-close")?.focus();
      }

      function toggleStepdown(show){
        const el = document.getElementById("stepdown-overlay");
        if(!el) return;
        if(!show){
          stopSpeak();
          document.getElementById("query")?.focus();
        }
        el.classList.toggle("active", !!show);
        el.setAttribute("aria-hidden", show ? "false" : "true");
        setBodyLock(show || isOpen("urgent-overlay") || isOpen("info-overlay"));
        if(show) document.getElementById("stepdown-close")?.focus();
      }

      /* =========================
         STEP FLOW (single engine)
      ========================== */
      let activeDecks = null;   // CRISIS_DECKS or URGENT_DECKS
      let activeKey = null;
      let stepIndex = 0;

      /* EXIT DECK: Single function for all exits. Returns to Home/List reliably.
         No completion screens, no confirmations, no shame language. */
      function exitDeck(){
        stopSpeak();
        activeDecks = null;
        activeKey = null;
        stepIndex = 0;
        
        // Clear search UI so home state is clean
        const searchInput = document.getElementById("query");
        if(searchInput) searchInput.value = "";
        renderSuggestions([]);
        
        toggleStepdown(false);
      }

      /* OPEN DECK: Always resets state to ensure fresh start.
         - stepIndex reset to 0
         - previous card content cleared via new activeDecks/activeKey
         - step indicator will show "Step 1 of N" for the new card */
      function openDeck(decks, key){
        if(!decks[key]) return;
        
        // STATE RESET: Clear previous deck state before opening new
        activeDecks = decks;
        activeKey = key;
        stepIndex = 0;  // Always start at step 1
        
        // Show call button for urgent decks
        const callBtn = document.getElementById("stepdown-call");
        const callLabel = document.getElementById("stepdown-call-label");
        if(decks === URGENT_DECKS){
          callBtn.style.display = "block";
          callLabel.textContent = `Call ${emergencyNumber}`;
        } else {
          callBtn.style.display = "none";
        }
        
        renderStep();
        toggleStepdown(true);
      }

      function renderStep(){
        const deck = activeDecks?.[activeKey];
        if(!deck) return;
        
        // BOUNDS SAFETY: If stepIndex somehow out of range, exit safely
        if(stepIndex < 0 || stepIndex >= deck.steps.length){
          exitDeck();
          return;
        }

        const step = deck.steps[stepIndex];
        document.getElementById("stepdown-title").textContent = deck.title;
        document.getElementById("stepdown-progress").textContent = `Step ${stepIndex+1} of ${deck.steps.length}`;
        
        // SAY section: Show only if step.say exists and is non-empty
        const saySection = document.getElementById("stepdown-say-section");
        const sayText = document.getElementById("stepdown-say");
        const doKicker = document.getElementById("stepdown-do-kicker");
        const doText = document.getElementById("stepdown-do");
        
        if(step.say){
          saySection.style.display = "block";
          sayText.textContent = injectEmergencyNumber(step.say);
          doKicker.textContent = "You can do this";
          doText.classList.remove("do-only");
        } else {
          saySection.style.display = "none";
          doKicker.textContent = "Do this";
          doText.classList.add("do-only");  // Largest text in app for DO-only steps
        }
        
        // DO section: Always show if step.do exists (with emergency number injection)
        doText.textContent = injectEmergencyNumber(step.do) || "";

        const back = document.getElementById("stepdown-back");
        const next = document.getElementById("stepdown-next");
        
        // Back disabled at first step (visual only - prevStep handles exit)
        back.disabled = false;  // Keep enabled so it can exit
        back.style.opacity = stepIndex === 0 ? "0.5" : "1";

        const isLast = stepIndex === deck.steps.length - 1;
        next.textContent = isLast ? "Done" : "Next";

        stopSpeak(); // stop speech when step changes
      }

      function nextStep(){
        const deck = activeDecks?.[activeKey];
        if(!deck) return;
        
        if(stepIndex < deck.steps.length - 1){
          stepIndex++;
          renderStep();
        } else {
          // LAST STEP: Next/Done exits to home
          exitDeck();
        }
      }

      function prevStep(){
        if(stepIndex > 0){
          stepIndex--;
          renderStep();
        } else {
          // FIRST STEP: Back exits to home/list
          exitDeck();
        }
      }

      /* =========================
         TEXT-TO-SPEECH (Speaker)
      ========================== */
      let speaking = false;
      let preferredVoice = null;

      function pickVoice(){
        try{
          const voices = window.speechSynthesis?.getVoices?.() || [];
          preferredVoice =
            voices.find(v => /en-GB/i.test(v.lang)) ||
            voices.find(v => /en/i.test(v.lang)) ||
            voices[0] || null;
        }catch(_){}
      }

      function updateListenUI(){
        const btn = document.getElementById("listen-btn");
        if(!btn) return;
        btn.classList.toggle("speaking", speaking);
        btn.setAttribute("aria-label", speaking ? "Stop listening" : "Listen to this step");
        const label = btn.querySelector(".listen-label");
        if(label) label.textContent = speaking ? "Stop" : "Listen";
      }

      function stopSpeak(){
        if("speechSynthesis" in window){
          window.speechSynthesis.cancel();
        }
        speaking = false;
        updateListenUI();
      }

      function speakCurrent(){
        const deck = activeDecks?.[activeKey];
        if(!deck) return;

        if(!("speechSynthesis" in window)){
          alert("Text-to-speech isn’t available in this browser.");
          return;
        }

        if(speaking){
          stopSpeak();
          return;
        }

        const step = deck.steps[stepIndex];
        const sayPart = step.say ? `Words to say: ${injectEmergencyNumber(step.say)}. ` : "";
        const doPart = injectEmergencyNumber(step.do);
        const text = `${deck.title}. Step ${stepIndex+1}. ${sayPart}Do this: ${doPart}`;

        const u = new SpeechSynthesisUtterance(text);
        u.rate = 0.95;
        u.pitch = 1.0;
        if(preferredVoice) u.voice = preferredVoice;

        u.onend = () => { speaking = false; updateListenUI(); };
        u.onerror = () => { speaking = false; updateListenUI(); };

        speaking = true;
        updateListenUI();

        // cancel + speak in next tick for reliability
        window.speechSynthesis.cancel();
        setTimeout(() => window.speechSynthesis.speak(u), 0);
      }

      /* =========================
         VOICE INPUT (Mic) - optional
      ========================== */
      let recognition = null;
      let listening = false;

      function initSpeechRecognition(){
        const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
        if(!SR) return;

        recognition = new SR();
        recognition.lang = "en-GB";
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;

        recognition.onresult = (event) => {
          const txt = event.results?.[0]?.[0]?.transcript?.trim?.() || "";
          const input = document.getElementById("query");
          if(input && txt){
            input.value = txt;
            // Trigger search
            const results = searchSituations(txt);
            renderSuggestions(results);
          }
        };

        recognition.onend = () => {
          listening = false;
          document.getElementById("mic-btn")?.classList.remove("listening");
        };
      }

      function toggleMic(){
        if(!recognition){
          alert("Voice input isn’t available in this browser/device.");
          return;
        }
        const mic = document.getElementById("mic-btn");

        if(listening){
          recognition.stop();
          listening = false;
          mic?.classList.remove("listening");
          return;
        }

        listening = true;
        mic?.classList.add("listening");
        recognition.start();
      }

      /* =========================
         TEL buttons (Emergency)
      ========================== */
      let emergencyNumber = "999";
      let adviceNumber = "111";
      let isUK = true;

      function detectRegion(){
        try {
          const lang = navigator.language || navigator.userLanguage || "";
          const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || "";
          isUK = lang.toLowerCase().includes("gb") || 
                 lang.toLowerCase() === "en-gb" || 
                 tz.toLowerCase().includes("london") ||
                 tz.toLowerCase().includes("europe/london");
        } catch(e) {
          isUK = true; // Default to UK if detection fails
        }
        
        if (isUK) {
          emergencyNumber = "999";
          adviceNumber = "111";
        } else {
          emergencyNumber = "112";
          adviceNumber = null; // Hide advice button for non-UK
        }
      }

      function setupEmergencyPanel(){
        detectRegion();
        
        const emergencyBtn = document.getElementById("call-emergency");
        const adviceBtn = document.getElementById("call-advice");
        const emergencyNumEl = document.getElementById("emergency-number");
        const emergencyHint = document.getElementById("emergency-hint");
        
        emergencyNumEl.textContent = `Call ${emergencyNumber}`;
        
        // Inject emergency number into hint text
        if(emergencyHint){
          emergencyHint.textContent = injectEmergencyNumber("If you or they are in immediate danger, call {EMERGENCY} now.");
        }
        
        // Update info panel emergency line
        const infoEmergencyLine = document.getElementById("info-emergency-line");
        if(infoEmergencyLine){
          infoEmergencyLine.textContent = injectEmergencyNumber("If you or they are in immediate danger, call {EMERGENCY} now.");
        }
        
        if (!isUK || !adviceNumber) {
          adviceBtn.style.display = "none";
          emergencyBtn.style.flex = "1";
        }
      }

      function callEmergency(){
        window.location.href = `tel:${emergencyNumber}`;
      }

      function callAdvice(){
        if (adviceNumber) {
          window.location.href = `tel:${adviceNumber}`;
        }
      }

      /* Inject region-safe emergency number into copy strings */
      function injectEmergencyNumber(text){
        if(!text) return text;
        return text.replace(/\{EMERGENCY\}/g, emergencyNumber);
      }

      /* =========================
         WIRING
      ========================== */
      function wire(){
        // search input
        const searchInput = document.getElementById("query");
        searchInput.addEventListener("input", handleSearchInput);
        
        // search suggestions clicks
        const suggestions = document.getElementById("search-suggestions");
        suggestions.addEventListener("click", (e) => {
          const card = e.target.closest(".card");
          if(!card) return;
          const isUrgent = card.dataset.urgent === "true";
          openDeck(isUrgent ? URGENT_DECKS : CRISIS_DECKS, card.dataset.key);
          searchInput.value = "";
          renderSuggestions([]);
        });
        suggestions.addEventListener("keydown", (e) => {
          if(e.key !== "Enter" && e.key !== " ") return;
          const card = e.target.closest(".card");
          if(!card) return;
          e.preventDefault();
          const isUrgent = card.dataset.urgent === "true";
          openDeck(isUrgent ? URGENT_DECKS : CRISIS_DECKS, card.dataset.key);
          searchInput.value = "";
          renderSuggestions([]);
        });

        // home tiles (no input flicker)
        const grid = document.getElementById("grid-container");
        grid.addEventListener("click", (e) => {
          const card = e.target.closest(".card");
          if(!card) return;
          openDeck(CRISIS_DECKS, card.dataset.key);
        });
        grid.addEventListener("keydown", (e) => {
          if(e.key !== "Enter" && e.key !== " ") return;
          const card = e.target.closest(".card");
          if(!card) return;
          e.preventDefault();
          openDeck(CRISIS_DECKS, card.dataset.key);
        });

        // urgent open/close
        document.getElementById("urgent-open").addEventListener("click", () => toggleUrgent(true));
        document.getElementById("urgent-close").addEventListener("click", () => toggleUrgent(false));
        document.getElementById("urgent-overlay").addEventListener("click", (e) => {
          if(e.target.id === "urgent-overlay") toggleUrgent(false);
        });

        // urgent rows -> open urgent decks (FIXED)
        const urgentList = document.getElementById("urgent-grid-sheet");
        urgentList.addEventListener("click", (e) => {
          const row = e.target.closest(".urgent-row");
          if(!row) return;
          toggleUrgent(false);
          openDeck(URGENT_DECKS, row.dataset.urgent);
        });
        urgentList.addEventListener("keydown", (e) => {
          if(e.key !== "Enter" && e.key !== " ") return;
          const row = e.target.closest(".urgent-row");
          if(!row) return;
          e.preventDefault();
          toggleUrgent(false);
          openDeck(URGENT_DECKS, row.dataset.urgent);
        });

        // stepdown controls
        document.getElementById("stepdown-next").addEventListener("click", nextStep);
        document.getElementById("stepdown-back").addEventListener("click", prevStep);
        document.getElementById("stepdown-done").addEventListener("click", exitDeck);  // Done = exit to home
        document.getElementById("stepdown-close").addEventListener("click", exitDeck); // Close = exit to home
        document.getElementById("stepdown-call").addEventListener("click", callEmergency);
        document.getElementById("stepdown-emergency").addEventListener("click", () => {
          toggleStepdown(false);
          toggleUrgent(true);
        });
        document.getElementById("stepdown-overlay").addEventListener("click", (e) => {
          if(e.target.id === "stepdown-overlay") toggleStepdown(false);
        });

        // speaker
        document.getElementById("listen-btn").addEventListener("click", speakCurrent);

        // mic
        document.getElementById("mic-btn").addEventListener("click", toggleMic);

        // Info
        document.getElementById("info-open").addEventListener("click", () => toggleInfo(true));
        document.getElementById("info-close").addEventListener("click", () => toggleInfo(false));
        document.getElementById("info-overlay").addEventListener("click", (e) => {
          if(e.target.id === "info-overlay") toggleInfo(false);
        });

        // 999 / 111
        document.getElementById("call-emergency").addEventListener("click", callEmergency);
        document.getElementById("call-advice").addEventListener("click", callAdvice);

        // View all situations
        document.getElementById("view-all-btn").addEventListener("click", toggleViewAll);

        // global Escape closes the topmost overlay
        document.addEventListener("keydown", (e) => {
          if(e.key !== "Escape") return;
          if(isOpen("stepdown-overlay")) toggleStepdown(false);
          else if(isOpen("urgent-overlay")) toggleUrgent(false);
          else if(isOpen("info-overlay")) toggleInfo(false);
        });
      }

      document.addEventListener("DOMContentLoaded", () => {
        // Detect region first so emergency number is set before any rendering
        detectRegion();
        
        renderHome();
        renderUrgentSheet();
        setupEmergencyPanel();
        initSpeechRecognition();

        // voices often load async
        if("speechSynthesis" in window){
          pickVoice();
          window.speechSynthesis.onvoiceschanged = pickVoice;
        }

        wire();
      });
    </script>
  
</body></html>